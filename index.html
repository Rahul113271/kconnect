<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KisanConnect - Your Local RaituBazar</title>
    <!-- Added Chart.js for the Growth Graph -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Razorpay Checkout Script -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <style>
        /* 1. Base Styles & Global Utilities */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        :root {
            /* Light Theme (Default) */
            --color-primary: #10b981;
            /* Green */
            --color-primary-dark: #059669;
            /* Darker Green */
            --color-secondary: #8b5cf6;
            /* Purple */
            --color-secondary-dark: #7c3aed;
            /* Darker Purple */
            --color-accent: #f59e0b;
            /* Amber/Gold */
            --color-background: #f8fafc;
            --color-text-dark: #1f2937;
            --color-text-light: #6b7280;
            --color-card-bg: #ffffff;
            --color-border: #e2e8f0;
            --color-chat-user: #e0f2f1;
            /* Teal 50 */
            --color-chat-gemini: #f3f4f6;
            /* Gray 100 */
            --color-danger: #ef4444;
            /* Red */
            --color-danger-dark: #dc2626;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --gradient-primary: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --gradient-secondary: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        /* Dark Theme Variables */
        [data-theme="dark"] {
            --color-primary: #34d399;
            /* Lighter Green for dark mode */
            --color-primary-dark: #10b981;
            --color-secondary: #a78bfa;
            /* Lighter Purple */
            --color-secondary-dark: #8b5cf6;
            --color-accent: #fbbf24;
            --color-background: #0f172a;
            /* Slate 900 - Richer dark */
            --color-text-dark: #f8fafc;
            /* Slate 50 */
            --color-text-light: #94a3b8;
            /* Slate 400 */
            --color-card-bg: #1e293b;
            /* Slate 800 */
            --color-border: #334155;
            /* Slate 700 */
            --color-chat-user: #064e3b;
            /* Dark Green for user chat */
            --color-chat-gemini: #334155;
            /* Slate 700 for AI chat */
            --color-danger: #f87171;
            /* Lighter Red */
            --color-danger-dark: #ef4444;
            --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.5);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --gradient-primary: linear-gradient(135deg, #059669 0%, #047857 100%);
            --gradient-secondary: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);
        }

        /* NEW: Added box-sizing */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        /* Animation Keyframes */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse-ring {
            0% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        /* NEW: Voice Search Animation */
        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* Utility Class for Animations */
        .animate-fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-background);
            color: var(--color-text-dark);
            margin: 0;
            padding: 0;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .flex-col-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* 1A. NEW: Landing Page */
        #landingPage {
            display: none;
            background-color: var(--color-background);
        }

        .lp-nav {
            background-color: var(--color-card-bg);
            padding: 1rem;
            border-bottom: 1px solid var(--color-border);
            position: sticky;
            top: 0;
            z-index: 100;
            transition: background-color 0.3s;
        }

        .lp-nav .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lp-logo {
            font-size: 1.875rem;
            font-weight: 800;
            color: var(--color-primary-dark);
            text-decoration: none;
        }

        /* NEW: Language Selector Styles */
        .lang-select {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text-dark);
            padding: 0.25rem 0.5rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            cursor: pointer;
            margin-right: 0.5rem;
            outline: none;
        }

        .lang-select option {
            background-color: var(--color-card-bg);
            color: var(--color-text-dark);
        }

        /* Theme Toggle Button */
        .theme-toggle {
            background: none;
            border: none;
            color: var(--color-text-dark);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s, color 0.3s;
            margin-left: 0.5rem;
        }

        .theme-toggle:hover {
            background-color: var(--color-border);
        }

        .lp-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
        }

        .lp-btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3);
        }

        .lp-btn-primary:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.4);
        }

        .lp-btn-secondary {
            background-color: var(--color-card-bg);
            color: var(--color-text-dark);
            border: 1px solid var(--color-border);
        }

        .lp-btn-secondary:hover {
            background-color: var(--color-background);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Landing Hero Section */
        .lp-hero {
            padding: 4rem 1rem;
            text-align: left;
        }

        .lp-hero .container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            align-items: center;
        }

        @media (min-width: 768px) {
            .lp-hero .container {
                grid-template-columns: repeat(2, 1fr);
                gap: 4rem;
            }
        }

        .hero-text h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--color-text-dark);
            line-height: 1.2;
            margin-bottom: 1rem;
        }

        @media (min-width: 768px) {
            .hero-text h1 {
                font-size: 3.5rem;
            }
        }

        .hero-text h1 span {
            color: var(--color-primary-dark);
        }

        .hero-text p {
            font-size: 1.125rem;
            color: var(--color-text-light);
            margin-bottom: 2rem;
        }

        .hero-buttons {
            display: flex;
            gap: 1rem;
        }

        .hero-image-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .hero-image-card {
            background-color: var(--color-card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            border: 1px solid var(--color-border);
            font-size: 4rem;
            box-shadow: var(--shadow-md);
            transition: all 0.3s;
        }

        .hero-image-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }

        [data-theme="dark"] .hero-image-card {
            background-color: #2d3748;
        }

        /* Feature Flip Cards Section */
        .lp-features {
            background-color: var(--color-card-bg);
            padding: 4rem 1rem;
            text-align: center;
            transition: background-color 0.3s;
        }

        .lp-features h2 {
            font-size: 2.25rem;
            font-weight: 800;
            margin-bottom: 1rem;
            color: var(--color-text-dark);
        }

        .lp-features>p {
            font-size: 1.125rem;
            color: var(--color-text-light);
            margin-bottom: 3rem;
        }

        .feature-card-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
            perspective: 1000px;
            flex-wrap: wrap;
        }

        .feature-card {
            width: 300px;
            height: 350px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            border-radius: 1.5rem;
        }

        .feature-card.is-flipped {
            transform: rotateY(180deg);
        }

        .feature-card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 1rem;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--color-border);
        }

        .feature-card-front {
            background-color: var(--color-card-bg);
        }

        .feature-card-front .icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .feature-card-front h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--color-text-dark);
        }

        .feature-card-front p {
            font-size: 0.875rem;
            color: var(--color-text-light);
        }

        .feature-card-back {
            background-color: var(--color-primary-dark);
            color: white;
            transform: rotateY(180deg);
        }

        .feature-card-back h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: white;
        }

        .feature-card-back p {
            font-size: 1rem;
            line-height: 1.6;
            color: white;
        }

        /* Stats Section */
        .lp-stats {
            background-color: var(--color-primary-dark);
            color: white;
            padding: 4rem 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
        }

        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .stat-item {
            text-align: center;
        }

        .stat-item h3 {
            font-size: 3rem;
            font-weight: 800;
            margin: 0;
            color: white;
        }

        .stat-item p {
            font-size: 1rem;
            font-weight: 300;
            margin: 0;
            color: rgba(255, 255, 255, 0.9);
        }

        /* CTA Section */
        .lp-cta {
            background-color: var(--color-background);
            padding: 5rem 1rem;
            text-align: center;
        }

        .lp-cta h2 {
            font-size: 2.25rem;
            font-weight: 800;
            margin-bottom: 1rem;
            color: var(--color-text-dark);
        }

        .lp-cta p {
            font-size: 1.125rem;
            color: var(--color-text-light);
            margin-bottom: 2rem;
            max-width: 42rem;
            margin-left: auto;
            margin-right: auto;
        }


        /* 2. Loading Indicator */
        #loadingIndicator {
            position: fixed;
            inset: 0;
            background-color: var(--color-background);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }

        .spinner {
            animation: spin 1s linear infinite;
            border-radius: 50%;
            height: 48px;
            width: 48px;
            border-bottom: 2px solid var(--color-primary-dark);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* 3. LOGIN VIEW (Home Page) */
        #loginView {
            min-height: 100vh;
            background-color: var(--color-background);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
        }

        .login-card {
            background-color: var(--color-card-bg);
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 1000px;
            text-align: center;
            border: 1px solid var(--color-border);
            animation: fadeIn 0.6s ease-out;
        }

        @media (min-width: 768px) {
            .login-card {
                padding: 3rem;
            }
        }

        .login-card h1 {
            font-size: 2rem;
            font-weight: 800;
            color: var(--color-primary-dark);
            margin-bottom: 0.5rem;
        }

        @media (min-width: 768px) {
            .login-card h1 {
                font-size: 2.5rem;
            }
        }

        .role-grid {
            display: grid;
            gap: 1.5rem;
            margin-top: 2rem;
            grid-template-columns: repeat(1, 1fr);
        }

        @media (min-width: 768px) {
            .role-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .role-card {
            padding: 2rem;
            border-radius: 1rem;
            border: 2px solid transparent;
            background-color: var(--color-background);
            cursor: pointer;
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .role-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
            background-color: var(--color-card-bg);
            border-color: var(--color-primary);
        }

        .role-card h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-top: 0.5rem;
        }

        .role-card span {
            display: inline-block;
            margin-top: 1rem;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            color: white;
            border: none;
            transition: transform 0.2s;
        }

        .role-card:hover span {
            transform: scale(1.05);
        }

        .role-card .icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .customer-card h3 {
            color: #2563eb;
        }

        .customer-card span {
            background-color: #2563eb;
        }

        .customer-card .icon {
            color: #2563eb;
        }

        [data-theme="dark"] .customer-card h3 {
            color: #60a5fa;
        }

        [data-theme="dark"] .customer-card .icon {
            color: #60a5fa;
        }

        .farmer-card h3 {
            color: var(--color-primary-dark);
        }

        .farmer-card span {
            background-color: var(--color-primary-dark);
        }

        .farmer-card .icon {
            color: var(--color-primary-dark);
        }

        #authStatus {
            margin-top: 2rem;
            font-size: 0.9rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px dashed var(--color-border);
            color: var(--color-text-light);
        }


        /* 4. Main Application Layout */
        #mainApp {
            display: none;
        }

        header {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 50;
            transition: background-color 0.3s;
            border-bottom: 1px solid var(--color-border);
        }

        [data-theme="dark"] header {
            background-color: rgba(30, 41, 59, 0.9);
        }

        header nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            header nav {
                flex-direction: column;
                align-items: center;
                gap: 1rem;
            }

            .nav-info {
                justify-content: center;
            }
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--color-primary-dark);
            text-decoration: none;
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            .logo {
                font-size: 1.875rem;
            }
        }

        /* Navigation Left Section (Logo + Controls) */
        .nav-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        /* Navigation Right Section (Links + Actions) */
        .nav-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        @media (min-width: 768px) {
            .nav-info {
                gap: 0.75rem;
                justify-content: flex-end;
            }
        }

        #roleDisplay {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--color-text-light);
            background-color: var(--color-background);
            padding: 0.2rem 0.5rem;
            border-radius: 9999px;
            text-transform: capitalize;
            border: 1px solid var(--color-border);
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            #roleDisplay {
                font-size: 0.875rem;
                padding: 0.25rem 0.75rem;
            }
        }

        #locationBlock {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-text-light);
            padding: 0.2rem 0.5rem;
            border: 1px solid var(--color-border);
            border-radius: 9999px;
            background-color: var(--color-background);
            cursor: pointer;
            transition: background-color 0.15s, box-shadow 0.15s;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            #locationBlock {
                font-size: 0.875rem;
                padding: 0.25rem 0.75rem;
                gap: 0.4rem;
                max-width: none;
            }
        }

        #locationBlock:hover {
            background-color: var(--color-card-bg);
            box-shadow: 0 0 0 2px var(--color-primary);
        }

        .signout-btn {
            background-color: var(--color-danger);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background-color 0.15s, transform 0.15s;
        }

        .signout-btn:hover {
            background-color: var(--color-danger-dark);
            transform: scale(1.05);
        }

        .nav-link {
            padding: 0.4rem 0.6rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--color-text-light);
            cursor: pointer;
            transition: background-color 0.15s, color 0.15s;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            border: none;
            background: none;
            white-space: nowrap;
        }

        @media (min-width: 768px) {
            .nav-link {
                padding: 0.5rem 0.75rem;
                font-size: 0.875rem;
                gap: 0.4rem;
            }
        }

        .nav-link:hover {
            background-color: var(--color-background);
            color: var(--color-primary-dark);
        }

        .nav-link svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        @media (min-width: 768px) {
            .nav-link svg {
                width: 20px;
                height: 20px;
            }
        }

        /* NEW: Farmer Tools Dropdown */
        .nav-dropdown {
            position: relative;
            display: none;
            /* Hidden by default, shown when farmer is logged in */
        }

        .dropdown-trigger {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.5rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
            font-size: 0.85rem;
            color: white;
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(55, 165, 82, 0.3);
        }

        .dropdown-trigger:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(55, 165, 82, 0.4);
        }

        .dropdown-trigger svg {
            width: 18px;
            height: 18px;
            transition: transform 0.2s ease;
        }

        .nav-dropdown.open .dropdown-trigger svg:last-child {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            min-width: 200px;
            background-color: var(--color-card-bg);
            border-radius: 0.75rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-border);
            padding: 0.5rem 0;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
        }

        .nav-dropdown.open .dropdown-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            width: 100%;
            border: none;
            background: none;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text-dark);
            cursor: pointer;
            transition: background-color 0.15s ease;
            text-align: left;
        }

        .dropdown-item:hover {
            background-color: var(--color-background);
        }

        .dropdown-item svg {
            width: 18px;
            height: 18px;
            color: var(--color-primary-dark);
            flex-shrink: 0;
        }

        .dropdown-divider {
            height: 1px;
            background-color: var(--color-border);
            margin: 0.5rem 0;
        }

        #cartButton {
            padding: 0.5rem;
            background-color: var(--color-background);
            color: var(--color-primary-dark);
            border-radius: 9999px;
            transition: background-color 0.15s, transform 0.15s;
            position: relative;
            border: 1px solid var(--color-border);
            cursor: pointer;
        }

        #cartButton:hover {
            background-color: var(--color-card-bg);
            transform: scale(1.1);
        }

        #cartCounter {
            position: absolute;
            top: -4px;
            right: -4px;
            background-color: var(--color-danger);
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        /* 5. Customer Market Hero */
        .hero-section {
            background: var(--gradient-primary);
            color: white;
            padding: 5rem 1rem;
            text-align: center;
            border-radius: 0 0 2rem 2rem;
            margin-bottom: 2rem;
        }

        .hero-section h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            letter-spacing: -0.05em;
            color: white;
        }

        @media (min-width: 640px) {
            .hero-section h1 {
                font-size: 3.75rem;
            }
        }

        .hero-section p {
            font-size: 1.125rem;
            font-weight: 300;
            margin-bottom: 2rem;
            max-width: 48rem;
            margin: 0 auto 2rem auto;
            color: white;
        }

        @media (min-width: 640px) {
            .hero-section p {
                font-size: 1.25rem;
            }
        }

        .hero-buttons {
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 1rem;
        }

        .hero-buttons button {
            border: none;
            font-weight: 700;
            padding: 0.75rem 2rem;
            border-radius: 9999px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s, transform 0.3s;
            cursor: pointer;
            width: 100%;
        }

        @media (min-width: 640px) {
            .hero-buttons {
                flex-direction: row;
                gap: 1rem;
            }

            .hero-buttons button {
                width: auto;
            }
        }

        .shop-btn {
            background-color: #facc15;
            color: #064e3b;
        }

        .shop-btn:hover {
            background-color: #eab308;
            transform: scale(1.05);
        }

        .recipe-btn {
            background-color: var(--color-secondary);
            color: white;
        }

        .recipe-btn:hover {
            background-color: #7c3aed;
            transform: scale(1.05);
        }

        /* 6. Product Grid & Filter */
        #products {
            padding: 3rem 0;
            background-color: var(--color-card-bg);
            transition: background-color 0.3s;
        }

        @media (min-width: 768px) {
            #products {
                padding: 4rem 0;
            }
        }

        #products h2 {
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            color: var(--color-text-dark);
            margin-bottom: 2rem;
        }

        @media (min-width: 768px) {
            #products h2 {
                font-size: 2.25rem;
            }
        }

        /* Responsive Filter Bar */
        #filterBar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
            background-color: var(--color-card-bg);
            border-radius: 1rem;
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow-sm);
        }

        #filterBar .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            width: 100%;
        }

        #filterBar label {
            font-weight: 600;
            color: var(--color-primary-dark);
        }

        #filterBar input[type="range"],
        #filterBar select,
        #filterBar input[type="text"] {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid var(--color-border);
            border-radius: 0.5rem;
            box-sizing: border-box;
            background-color: var(--color-background);
            color: var(--color-text-dark);
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        #filterBar input:focus,
        #filterBar select:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        /* NEW: Voice Search Button Styles */
        .voice-btn {
            background: var(--color-background);
            border: 1px solid var(--color-border);
            color: var(--color-text-dark);
            padding: 0.6rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            /* Accessible touch target */
        }

        .voice-btn:hover {
            background-color: var(--color-card-bg);
            border-color: var(--color-primary);
            color: var(--color-primary);
        }

        .voice-btn.listening {
            animation: pulse-red 1.5s infinite;
            background-color: #fee2e2;
            border-color: var(--color-danger);
            color: var(--color-danger);
        }

        /* Dark mode adjustment for voice button */
        [data-theme="dark"] .voice-btn.listening {
            background-color: #450a0a;
        }

        #priceRangeValue {
            font-weight: 700;
            color: var(--color-danger);
        }

        @media (min-width: 768px) {
            #filterBar {
                flex-direction: row;
                justify-content: space-between;
                align-items: flex-end;
                gap: 2rem;
            }

            #filterBar .filter-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
                width: auto;
                flex: 1;
            }

            #filterBar input[type="range"],
            #filterBar select,
            #filterBar input[type="text"] {
                width: 100%;
                min-width: 150px;
            }
        }

        #productGrid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(1, 1fr);
        }

        @media (min-width: 640px) {
            #productGrid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1.5rem;
            }
        }

        @media (min-width: 1024px) {
            #productGrid {
                grid-template-columns: repeat(3, 1fr);
                gap: 2rem;
            }
        }

        @media (min-width: 1280px) {
            #productGrid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Product Card */
        .product-card {
            background-color: var(--color-card-bg);
            border-radius: 1rem;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            border: 1px solid var(--color-border);
            transition: all 0.3s ease;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .product-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-5px);
            border-color: var(--color-primary);
        }

        .product-card img {
            width: 100%;
            height: 14rem;
            object-fit: cover;
            object-position: center;
            transition: transform 0.5s ease;
        }

        .product-card:hover img {
            transform: scale(1.05);
        }

        .card-content {
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .card-header h3 {
            font-size: 1.15rem;
            line-height: 1.4;
            font-weight: 700;
            color: var(--color-text-dark);
        }

        .freshness-tag {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-primary-dark);
            background-color: var(--color-background);
            border: 1px solid var(--color-border);
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            white-space: nowrap;
        }

        .price-tag {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--color-primary-dark);
            margin-bottom: 0.5rem;
        }

        .price-tag .unit {
            font-size: 0.875rem;
            font-weight: 400;
            color: var(--color-text-light);
        }

        .seller-info {
            font-size: 0.875rem;
            color: var(--color-text-light);
            margin-bottom: 0.25rem;
        }

        .location-info {
            font-size: 0.875rem;
            color: var(--color-text-light);
            margin-bottom: 1rem;
            font-weight: 500;
        }

        /* NEW: Stock specific styles */
        .stock-info {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-secondary);
            margin-bottom: 0.5rem;
        }

        .stock-info.out-of-stock {
            color: var(--color-danger);
        }

        .add-to-cart-btn {
            width: 100%;
            background: var(--gradient-primary);
            color: white;
            padding: 0.85rem;
            border-radius: 0.75rem;
            border: none;
            font-weight: 600;
            font-size: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.2s;
            margin-top: auto;
        }

        .add-to-cart-btn:hover {
            filter: brightness(1.1);
            transform: translateY(-1px);
            box-shadow: 0 6px 8px -1px rgba(0, 0, 0, 0.15);
        }

        .add-to-cart-btn:active {
            transform: scale(0.98);
        }

        .add-to-cart-btn:disabled {
            background: #cbd5e1;
            color: #64748b;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 7. Footer */
        footer {
            background-color: #1f2937;
            color: white;
            padding: 2.5rem 1rem;
            margin-top: 4rem;
            text-align: center;
        }

        footer p {
            color: #9ca3af;
            margin-bottom: 1rem;
        }

        footer a {
            color: #9ca3af;
            text-decoration: none;
            transition: color 0.15s;
            margin: 0 0.75rem;
        }

        footer a:hover {
            color: #34d399;
        }

        /* Footer (Shared by all main views and landing page) */
        .lp-footer {
            background-color: #1f2937;
            color: white;
            padding: 2.5rem 1rem;
            text-align: center;
        }

        .lp-footer p {
            color: #9ca3af;
            margin-bottom: 1rem;
        }

        .lp-footer a {
            color: #9ca3af;
            text-decoration: none;
            transition: color 0.15s;
            margin: 0 0.75rem;
        }

        .lp-footer a:hover {
            color: #34d399;
        }


        /* 8. Modals */
        .modal-backdrop {
            backdrop-filter: blur(4px);
            background-color: rgba(0, 0, 0, 0.6);
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
            padding: 1rem;
        }

        .modal-content {
            background-color: var(--color-card-bg);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-lg);
            max-width: 24rem;
            width: 100%;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            color: var(--color-text-dark);
        }

        .modal-btn {
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            color: white;
            transition: background-color 0.15s, opacity 0.15s;
        }

        .modal-btn:hover {
            opacity: 0.9;
        }

        .modal-btn.success {
            background-color: var(--color-primary-dark);
        }

        .modal-btn.llm-close {
            background-color: var(--color-secondary);
        }

        .modal-btn.cancel {
            background-color: var(--color-text-light);
            margin-top: 0.5rem;
        }


        /* Location Modal Specific Styles */
        #locationModalContent {
            max-width: 400px;
        }

        #locationModalContent h3 {
            color: var(--color-text-dark);
        }

        #locationModalContent p {
            color: var(--color-text-light);
        }

        #locationModalContent .option-card {
            border: 1px solid var(--color-border);
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.15s, border-color 0.15s;
        }

        #locationModalContent .option-card:hover {
            background-color: var(--color-background);
            border-color: var(--color-primary);
        }

        #manualLocationInput {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: 0.5rem;
            box-sizing: border-box;
            margin-top: 0.5rem;
            background-color: var(--color-background);
            color: var(--color-text-dark);
        }

        .set-location-btn {
            background-color: #2563eb;
            color: white;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .set-location-btn:hover {
            background-color: #1d4ed8;
        }

        /* Login Form Modal Styles */
        #loginFormModalContent {
            max-width: 450px;
        }

        #loginFormModalContent h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-align: center;
            color: var(--color-text-dark);
        }

        .auth-tabs {
            display: flex;
            border-bottom: 1px solid var(--color-border);
            margin-bottom: 1.5rem;
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 0.75rem 0.5rem;
            font-weight: 600;
            color: var(--color-text-light);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: color 0.15s, border-color 0.15s;
        }

        .auth-tab.active {
            color: var(--color-primary-dark);
            border-bottom-color: var(--color-primary-dark);
        }

        #loginForm,
        #registerForm {
            display: none;
        }

        #loginForm.active,
        #registerForm.active {
            display: block;
        }

        #loginForm label,
        #registerForm label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--color-text-dark);
        }

        #loginForm input,
        #registerForm input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: 0.5rem;
            box-sizing: border-box;
            margin-bottom: 1rem;
            background-color: var(--color-background);
            color: var(--color-text-dark);
        }

        #loginForm button[type="submit"],
        #registerForm button[type="submit"] {
            background-color: var(--color-primary-dark);
            color: white;
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        #loginForm button[type="submit"]:hover,
        #registerForm button[type="submit"]:hover {
            background-color: var(--color-primary);
        }

        /* Edit Product Modal Styles */
        #editProductModalContent {
            max-width: 600px;
        }

        #editProductForm .form-group {
            margin-bottom: 1rem;
        }

        #editProductForm label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--color-primary-dark);
        }

        #editProductForm input,
        #editProductForm select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: 0.5rem;
            box-sizing: border-box;
            background-color: var(--color-background);
            color: var(--color-text-dark);
        }

        #editProductForm button[type="submit"] {
            background-color: #facc15;
            color: #064e3b;
            width: 100%;
            margin-top: 1rem;
        }

        /* NEW: Helper text for file input */
        .form-group small {
            font-size: 0.8rem;
            color: var(--color-text-light);
            display: block;
            margin-top: 0.25rem;
        }


        /* 9. Farmer View */
        #farmerView {
            padding: 2rem 1rem;
            min-height: 80vh;
            background-color: var(--color-background);
        }

        .farmer-form-card {
            background-color: var(--color-card-bg);
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-lg);
            max-width: 600px;
            margin: 2rem auto 4rem auto;
            border: 1px solid var(--color-border);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--color-primary-dark);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: 0.5rem;
            box-sizing: border-box;
            background-color: var(--color-background);
            color: var(--color-text-dark);
        }

        .submit-btn {
            width: 100%;
            background-color: #facc15;
            color: #064e3b;
            font-weight: 700;
            padding: 0.75rem;
            border-radius: 9999px;
            border: none;
            cursor: pointer;
            margin-top: 1.5rem;
            transition: background-color 0.15s, transform 0.15s;
        }

        .submit-btn:hover {
            background-color: #eab308;
            transform: scale(1.02);
        }

        .submit-btn:disabled {
            background-color: #d1d5db;
            color: #6b7280;
            cursor: not-allowed;
        }

        #myListingsContainer {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(1, 1fr);
            margin-top: 2rem;
        }

        @media (min-width: 640px) {
            #myListingsContainer {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            #myListingsContainer {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .listing-card {
            background-color: var(--color-card-bg);
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--color-border);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .listing-card h4 {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--color-text-dark);
            margin-bottom: 0.5rem;
        }

        .listing-card .listing-details {
            margin-bottom: 1rem;
            color: var(--color-text-dark);
        }

        .listing-card .listing-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: auto;
        }

        .delete-btn {
            background-color: var(--color-danger);
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.15s;
        }

        .delete-btn:hover {
            background-color: var(--color-danger-dark);
        }

        .edit-btn {
            background-color: #2563eb;
            color: white;
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.15s;
        }

        .edit-btn:hover {
            background-color: #1d4ed8;
        }

        .optimize-btn {
            background-color: #facc15;
            color: #064e3b;
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            grid-column: 1 / -1;
            margin-top: 0.5rem;
            transition: background-color 0.15s;
        }

        .optimize-btn:hover {
            background-color: #eab308;
        }

        /* 10. Cart View */
        #cartPage {
            padding: 2rem 1rem;
            min-height: 80vh;
            background-color: var(--color-card-bg);
            display: none;
        }

        @media (min-width: 768px) {
            #cartPage {
                padding: 4rem 1rem;
            }
        }

        #cartPage h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--color-text-dark);
            margin-bottom: 2rem;
        }

        @media (min-width: 768px) {
            #cartPage h2 {
                font-size: 2.25rem;
            }
        }

        .cart-layout {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        @media (min-width: 1024px) {
            .cart-layout {
                flex-direction: row;
                align-items: flex-start;
            }

            .cart-summary {
                width: 350px;
                min-width: 300px;
            }
        }

        #cartItemsList {
            flex-grow: 1;
        }

        /* Responsive Cart Item */
        .cart-item {
            display: grid;
            grid-template-columns: 60px 1fr 60px;
            grid-template-rows: auto auto;
            align-items: center;
            border-bottom: 1px solid var(--color-border);
            padding: 1rem 0;
            gap: 0.5rem 1rem;
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .item-details {
            display: flex;
            align-items: center;
            gap: 1rem;
            grid-column: 1 / 2;
            grid-row: 1 / 3;
        }

        .item-details img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 0.5rem;
        }

        .item-name-unit {
            font-size: 1rem;
            font-weight: 600;
            grid-column: 2 / 3;
            grid-row: 1 / 2;
            color: var(--color-text-dark);
        }

        .item-price {
            font-size: 1rem;
            font-weight: 500;
            grid-column: 2 / 3;
            grid-row: 2 / 3;
            justify-self: start;
            color: var(--color-text-dark);
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            grid-column: 3 / 4;
            grid-row: 1 / 2;
        }

        .quantity-btn {
            background: none;
            border: 1px solid var(--color-border);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.25rem;
            line-height: 1;
            padding: 0;
            transition: background-color 0.15s;
            color: var(--color-text-dark);
        }

        .quantity-btn:hover {
            background-color: var(--color-background);
        }

        .quantity-display {
            font-weight: 700;
            min-width: 20px;
            text-align: center;
            color: var(--color-text-dark);
        }

        .remove-btn {
            background: none;
            border: none;
            color: var(--color-danger);
            cursor: pointer;
            font-size: 1.5rem;
            grid-column: 3 / 4;
            grid-row: 2 / 3;
        }

        @media (min-width: 768px) {
            .cart-item {
                grid-template-columns: auto 1fr auto auto auto;
                grid-template-rows: 1fr;
                gap: 1rem;
            }

            .item-details {
                grid-column: auto;
                grid-row: auto;
            }

            .item-name-unit {
                grid-column: auto;
                grid-row: auto;
            }

            .item-price {
                grid-column: auto;
                grid-row: auto;
                justify-self: auto;
            }

            .quantity-controls {
                grid-column: auto;
                grid-row: auto;
            }

            .remove-btn {
                grid-column: auto;
                grid-row: auto;
            }
        }

        .cart-summary {
            background-color: var(--color-background);
            border: 1px solid var(--color-border);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-sm);
            width: 100%;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px dashed var(--color-border);
            font-size: 1rem;
            color: var(--color-text-dark);
        }

        .summary-row:last-of-type {
            border-bottom: none;
            margin-top: 1rem;
            padding-top: 1rem;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-primary-dark);
        }

        .checkout-btn {
            width: 100%;
            padding: 1rem;
            background-color: var(--color-secondary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 1rem;
            transition: background-color 0.15s;
        }

        .checkout-btn:hover {
            background-color: #7c3aed;
        }

        /* Payment Method Options */
        .payment-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .payment-option {
            cursor: pointer;
        }

        .payment-option input {
            display: none;
        }

        .payment-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background-color: var(--color-card-bg);
            border: 2px solid var(--color-border);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--color-text-dark);
            transition: all 0.15s ease;
        }

        .payment-option input:checked+.payment-label {
            border-color: var(--color-primary);
            background-color: rgba(16, 185, 129, 0.1);
        }

        .payment-label:hover {
            border-color: var(--color-primary-dark);
        }

        .payment-icon {
            font-size: 1.25rem;
        }

        .empty-cart-message {
            text-align: center;
            padding: 3rem;
            background-color: var(--color-background);
            border-radius: 0.75rem;
            border: 1px dashed var(--color-border);
            color: var(--color-primary-dark);
            font-size: 1.125rem;
            font-weight: 500;
        }

        /* 11. Orders Page (Customer) */
        #ordersPage {
            padding: 2rem 1rem;
            min-height: 80vh;
            background-color: var(--color-background);
            display: none;
        }

        @media (min-width: 768px) {
            #ordersPage {
                padding: 4rem 1rem;
            }
        }

        #ordersPage h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--color-text-dark);
            text-align: center;
            margin-bottom: 2rem;
        }

        @media (min-width: 768px) {
            #ordersPage h2 {
                font-size: 2.25rem;
            }
        }

        /* Responsive Orders Header */
        .orders-header {
            max-width: 900px;
            margin: 0 auto 2rem auto;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        @media (min-width: 640px) {
            .orders-header {
                flex-direction: row;
            }
        }

        .back-button {
            background: none;
            border: 1px solid var(--color-border);
            color: var(--color-text-light);
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            transition: background-color 0.15s;
        }

        .back-button:hover {
            background-color: var(--color-background);
            color: var(--color-text-dark);
        }

        #ordersList {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .order-card {
            background-color: var(--color-card-bg);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--color-border);
        }

        .order-header-card {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-start;
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 0.75rem;
            margin-bottom: 0.75rem;
        }

        @media (min-width: 640px) {
            .order-header-card {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        .order-id {
            font-size: 1rem;
            font-weight: 500;
            color: var(--color-text-light);
        }

        .order-status {
            font-weight: 700;
            font-size: 1.125rem;
        }

        .order-status.processing {
            color: #f59e0b;
        }

        .order-status.delivered {
            color: var(--color-primary-dark);
        }

        .order-status.cancelled {
            color: var(--color-danger);
        }

        .order-details-summary {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-top: 0.5rem;
            align-items: flex-start;
        }

        @media (min-width: 640px) {
            .order-details-summary {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        .order-total {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--color-text-dark);
        }

        .order-delivery {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-text-light);
        }

        .order-item-list {
            margin-top: 1rem;
            padding: 0.5rem 0;
            border-top: 1px dashed var(--color-border);
            color: var(--color-text-dark);
        }

        .cancel-order-btn {
            background-color: var(--color-danger);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.15s;
        }

        .cancel-order-btn:hover {
            background-color: var(--color-danger-dark);
        }

        .order-card-footer {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--color-border);
            display: flex;
            justify-content: flex-end;
        }

        /* 12. CHAT BOT STYLES */
        #chatContainer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }

        #chatToggleBtn {
            background: var(--gradient-secondary);
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse-ring 2s infinite;
        }

        #chatToggleBtn:hover {
            transform: scale(1.1);
        }

        #chatWindow {
            position: absolute;
            bottom: 80px;
            right: 0;
            width: 320px;
            height: 400px;
            background-color: var(--color-card-bg);
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transform: scale(0.9) translateY(100%);
            /* Start scaled down */
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            pointer-events: none;
            transform-origin: bottom right;
            border: 1px solid var(--color-border);
        }

        #chatWindow.open {
            transform: scale(1) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        /* Responsive Chat Window */
        @media (max-width: 400px) {
            #chatWindow {
                width: calc(100vw - 2rem);
                /* Full width minus padding */
                height: 70vh;
                bottom: 80px;
                right: -10px;
                /* Adjust to align with button */
            }
        }

        #chatHeader {
            background: var(--gradient-secondary);
            color: white;
            padding: 0.75rem 1rem;
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #chatMessages {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            background-color: var(--color-background);
        }

        .chat-message {
            margin-bottom: 0.75rem;
            max-width: 85%;
        }

        .chat-message p {
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            line-height: 1.4;
            font-size: 0.9rem;
            white-space: pre-wrap;
        }

        .user-message {
            margin-left: auto;
            text-align: right;
        }

        .user-message p {
            background-color: var(--color-chat-user);
            color: var(--color-text-dark);
        }

        /* Adapted for dark mode */
        /* Special handling for user text color in dark mode if needed, but variable swap works well */
        [data-theme="dark"] .user-message p {
            color: #ffffff;
        }

        .gemini-message {
            margin-right: auto;
            text-align: left;
        }

        .gemini-message p {
            background-color: var(--color-chat-gemini);
            color: var(--color-text-dark);
            border: 1px solid var(--color-border);
        }

        #chatInputContainer {
            border-top: 1px solid var(--color-border);
            padding: 0.5rem;
            display: flex;
            background-color: var(--color-card-bg);
        }

        #chatInput {
            flex-grow: 1;
            padding: 0.5rem;
            border: 1px solid var(--color-border);
            border-radius: 0.5rem;
            margin-right: 0.5rem;
            background-color: var(--color-background);
            color: var(--color-text-dark);
        }

        #chatSendBtn {
            background-color: var(--color-primary-dark);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #chatSendBtn:hover {
            background-color: var(--color-primary);
        }

        .chat-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #8b5cf6;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        /* 13. NEW: Farmer Orders Page */
        #farmerOrdersPage {
            padding: 2rem 1rem;
            min-height: 80vh;
            background-color: var(--color-background);
            display: none;
        }

        @media (min-width: 768px) {
            #farmerOrdersPage {
                padding: 4rem 1rem;
            }
        }

        #farmerOrdersPage h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--color-primary-dark);
            text-align: center;
            margin-bottom: 2rem;
        }

        @media (min-width: 768px) {
            #farmerOrdersPage h2 {
                font-size: 2.25rem;
            }
        }

        #farmerOrdersList {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .farmer-order-item-card {
            background-color: var(--color-card-bg);
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--color-border);
        }

        .farmer-order-item-header {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-start;
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 0.75rem;
            margin-bottom: 1rem;
        }

        @media (min-width: 640px) {
            .farmer-order-item-header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }

        .farmer-order-item-header h4 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-text-dark);
            margin: 0;
        }

        .farmer-order-item-details p {
            margin: 0.25rem 0;
            font-size: 1rem;
            color: var(--color-text-dark);
        }

        /* 14. NEW: Profile Page Styles */
        #profilePage {
            padding: 2rem 1rem;
            min-height: 80vh;
            background-color: var(--color-background);
            display: none;
        }

        .profile-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .profile-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .profile-header h2 {
            font-size: 2rem;
            font-weight: 800;
            color: var(--color-text-dark);
        }

        .profile-card {
            background-color: var(--color-card-bg);
            border: 1px solid var(--color-border);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: var(--shadow-md);
        }

        .profile-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--color-primary-dark);
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 0.5rem;
        }

        .profile-section-title:first-of-type {
            margin-top: 0;
        }

        /* 15. NEW: Farmer Metrics Dashboard */
        .farmer-metrics-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 640px) {
            .farmer-metrics-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .metric-card {
            background-color: var(--color-card-bg);
            border: 1px solid var(--color-border);
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .metric-card h3 {
            font-size: 2rem;
            font-weight: 800;
            color: var(--color-primary-dark);
            margin: 0;
        }

        .metric-card p {
            color: var(--color-text-light);
            margin: 0.25rem 0 0;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* 16. NEW: Order Action Buttons */
        .farmer-order-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            border-top: 1px solid var(--color-border);
            padding-top: 1rem;
        }

        .accept-btn {
            flex: 1;
            background-color: var(--color-primary);
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .accept-btn:hover {
            background-color: var(--color-primary-dark);
        }

        .reject-btn {
            flex: 1;
            background-color: var(--color-card-bg);
            color: var(--color-danger);
            border: 1px solid var(--color-danger);
            padding: 0.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .reject-btn:hover {
            background-color: #fef2f2;
        }

        [data-theme="dark"] .reject-btn:hover {
            background-color: #450a0a;
        }

        /* 17. NEW: Progress Bar Styles */
        .progress-wrapper {
            margin-bottom: 1.5rem;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            color: var(--color-text-light);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .progress-track {
            width: 100%;
            height: 0.75rem;
            background-color: var(--color-border);
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--color-primary);
            width: 0%;
            transition: width 0.4s ease-in-out;
            border-radius: 9999px;
        }

        /* 18. NEW: Growth Chart Page */
        #farmerGrowthPage {
            padding: 2rem 1rem;
            min-height: 80vh;
            background-color: var(--color-background);
            display: none;
        }

        .growth-header-card {
            background-color: var(--color-card-bg);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
            text-align: center;
            border: 1px solid var(--color-border);
        }

        .growth-rate {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--color-primary);
            margin: 0.5rem 0;
        }

        .growth-rate.negative {
            color: var(--color-danger);
        }

        .chart-container {
            background-color: var(--color-card-bg);
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--color-border);
            height: 400px;
            position: relative;
        }

        /* 19. NEW: Toast Notification */
        #toastContainer {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background-color: var(--color-card-bg);
            color: var(--color-text-dark);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            border-left: 5px solid var(--color-primary);
            animation: slideIn 0.3s ease-out forwards;
            min-width: 300px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid var(--color-border);
        }

        .toast.toast-new-order {
            border-left-color: var(--color-secondary);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }

        /* 20. NEW: AI Crop Doctor Styles */
        #farmerCropDoctorPage {
            padding: 2rem 1rem;
            min-height: 80vh;
            background-color: var(--color-background);
            display: none;
        }

        .upload-area {
            border: 2px dashed var(--color-border);
            border-radius: 1rem;
            padding: 3rem;
            text-align: center;
            background-color: var(--color-card-bg);
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 2rem;
        }

        .upload-area:hover {
            border-color: var(--color-primary);
            background-color: #f0fdf4;
            /* Light green tint */
        }

        [data-theme="dark"] .upload-area:hover {
            background-color: #064e3b;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .crop-preview-container {
            max-width: 400px;
            margin: 0 auto 2rem auto;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            display: none;
            /* Hidden by default */
        }

        .crop-preview-container img {
            width: 100%;
            display: block;
        }

        .diagnosis-card {
            background-color: var(--color-card-bg);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-border);
            display: none;
            /* Hidden until result */
        }

        .diagnosis-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--color-border);
        }

        .diagnosis-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary-dark);
        }

        /* 21. NEW: Government Scheme Finder Styles */
        #farmerSchemesPage {
            padding: 2rem 1rem;
            min-height: 80vh;
            background-color: var(--color-background);
            display: none;
        }

        .scheme-form-card {
            background-color: var(--color-card-bg);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--color-border);
            max-width: 600px;
            margin: 0 auto 2rem auto;
        }

        .scheme-form-card h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-primary-dark);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .scheme-form-card>p {
            color: var(--color-text-light);
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .scheme-results-card {
            background-color: var(--color-card-bg);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--color-border);
            display: none;
            max-width: 800px;
            margin: 0 auto;
        }

        .scheme-results-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--color-border);
        }

        .scheme-results-header .icon-circle {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            padding: 0.75rem;
            border-radius: 50%;
            color: white;
        }

        .scheme-results-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--color-text-dark);
        }

        .scheme-item {
            background-color: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: 0.75rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }

        .scheme-item:hover {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-sm);
        }

        .scheme-item h4 {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--color-primary-dark);
            margin-bottom: 0.5rem;
        }

        .scheme-item p {
            color: var(--color-text-dark);
            line-height: 1.6;
            margin-bottom: 0.5rem;
        }

        .scheme-tag {
            display: inline-block;
            background-color: #fef3c7;
            color: #92400e;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            margin-right: 0.5rem;
            margin-top: 0.5rem;
        }

        [data-theme="dark"] .scheme-tag {
            background-color: #78350f;
            color: #fef3c7;
        }

        /* NEW: Scheme Link Button */
        .scheme-link {
            display: inline-block;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white !important;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-top: 0.75rem;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3);
        }

        .scheme-link:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(37, 99, 235, 0.4);
        }

        [data-theme="dark"] .scheme-link {
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
        }

        .scheme-emoji-header {
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        /* 22. NEW: Weather Forecast Page Styles */
        #farmerWeatherPage {
            padding: 1rem 1rem 2rem 1rem;
            background-color: var(--color-background);
            display: none;
        }

        .weather-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .weather-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .weather-header h2 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--color-text-dark);
            margin-bottom: 0.5rem;
        }

        .weather-header p {
            color: var(--color-text-light);
            font-size: 0.95rem;
        }

        .weather-location {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 0.75rem;
            font-weight: 600;
            color: var(--color-primary-dark);
        }

        /* Current Weather Card */
        .current-weather-card {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            border-radius: 1.5rem;
            padding: 2rem;
            color: white;
            margin-bottom: 2rem;
            box-shadow: 0 10px 40px rgba(14, 165, 233, 0.3);
        }

        .current-weather-main {
            display: flex;
            align-items: center;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 1.5rem;
        }

        .current-temp {
            font-size: 4rem;
            font-weight: 700;
            line-height: 1;
        }

        .current-temp span {
            font-size: 2rem;
            opacity: 0.8;
        }

        .current-weather-icon {
            font-size: 5rem;
        }

        .current-weather-details {
            text-align: center;
        }

        .current-condition {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .current-meta {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .current-meta-item {
            text-align: center;
        }

        .current-meta-item .label {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-bottom: 0.25rem;
        }

        .current-meta-item .value {
            font-size: 1.1rem;
            font-weight: 700;
        }

        /* 7-Day Forecast */
        .forecast-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--color-text-dark);
            margin-bottom: 1rem;
        }

        .forecast-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }

        .forecast-card {
            background-color: var(--color-card-bg);
            border: 1px solid var(--color-border);
            border-radius: 1rem;
            padding: 1.25rem 1rem;
            text-align: center;
            transition: all 0.2s ease;
        }

        .forecast-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
            border-color: var(--color-primary);
        }

        .forecast-day {
            font-weight: 700;
            color: var(--color-text-dark);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .forecast-date {
            font-size: 0.75rem;
            color: var(--color-text-light);
            margin-bottom: 0.75rem;
        }

        .forecast-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
        }

        .forecast-temps {
            display: flex;
            justify-content: center;
            gap: 0.75rem;
            font-weight: 600;
        }

        .forecast-high {
            color: #ef4444;
        }

        .forecast-low {
            color: #3b82f6;
        }

        .forecast-rain {
            font-size: 0.75rem;
            color: var(--color-text-light);
            margin-top: 0.5rem;
        }

        .forecast-rain span {
            color: #0ea5e9;
            font-weight: 600;
        }

        /* Farming Insights */
        .farming-insights {
            margin-top: 2rem;
            background-color: var(--color-card-bg);
            border: 1px solid var(--color-border);
            border-radius: 1rem;
            padding: 1.5rem;
        }

        .farming-insights h3 {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--color-primary-dark);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--color-border);
        }

        .insight-item:last-child {
            border-bottom: none;
        }

        .insight-icon {
            font-size: 1.5rem;
        }

        .insight-text {
            color: var(--color-text-dark);
            line-height: 1.5;
        }

        .insight-text strong {
            color: var(--color-primary-dark);
        }

        /* Weather Loading */
        .weather-loading {
            text-align: center;
            padding: 4rem 2rem;
        }

        .weather-error {
            text-align: center;
            padding: 2rem;
            color: var(--color-danger);
            background-color: #fee2e2;
            border-radius: 0.75rem;
        }

        [data-theme="dark"] .weather-error {
            background-color: #450a0a;
        }
    </style>
</head>

<body class="antialiased">

    <!-- Global Loading Indicator -->
    <div id="loadingIndicator">
        <div class="flex-col-center">
            <div class="spinner"></div>
            <p style="margin-top: 1rem; font-size: 1.125rem; color: #059669; font-weight: 600;">Connecting to
                KisanConnect...</p>
        </div>
    </div>

    <!-- NEW: Toast Container -->
    <div id="toastContainer"></div>

    <!-- 1. NEW: LANDING PAGE VIEW -->
    <section id="landingPage">
        <!-- Landing Page Navigation -->
        <nav class="lp-nav">
            <div class="container">
                <div style="display: flex; align-items: center;">
                    <a href="#" class="lp-logo">KisanConnect</a>

                    <!-- NEW: Language Toggle (Landing) -->
                    <select class="lang-select" onchange="setLanguage(this.value)" style="margin-left: 1rem;">
                        <option value="en">English</option>
                        <option value="te"></option>
                        <option value="hi"></option>
                    </select>

                    <!-- Theme Toggle -->
                    <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">
                        <svg id="sunIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" style="display: block;">
                            <circle cx="12" cy="12" r="4" />
                            <path d="M12 2v2" />
                            <path d="M12 20v2" />
                            <path d="m4.93 4.93 1.41 1.41" />
                            <path d="m17.66 17.66 1.41 1.41" />
                            <path d="M2 12h2" />
                            <path d="M20 12h2" />
                            <path d="m6.34 17.66-1.41-1.41" />
                            <path d="m19.07 4.93-1.41 1.41" />
                        </svg>
                        <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" style="display: none;">
                            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />
                        </svg>
                    </button>
                </div>
                <button onclick="showLoginView()" class="lp-btn lp-btn-primary" data-i18n="nav_login">
                    Login / Sign Up
                </button>
            </div>
        </nav>

        <!-- Landing Page Hero -->
        <section class="lp-hero">
            <div class="container">
                <div class="hero-text">
                    <h1 data-i18n="hero_title">Connecting Farmers Directly to <span>You</span></h1>
                    <p data-i18n="hero_desc">Connecting farmers directly with customers. Fresh produce, fair prices, and
                        a sustainable future for local agriculture.</p>
                    <div class="hero-buttons">
                        <button onclick="showLoginView()" class="lp-btn lp-btn-primary" data-i18n="get_started">
                            Get Started &rarr;
                        </button>
                        <button class="lp-btn lp-btn-secondary" data-i18n="learn_more">
                            Learn More
                        </button>
                    </div>
                </div>
                <div class="hero-image-grid">
                    <div class="hero-image-card"></div>
                    <div class="hero-image-card"></div>
                    <div class="hero-image-card"></div>
                    <div class="hero-image-card"></div>
                </div>
            </div>
        </section>

        <!-- Landing Page Features (Flashcards) -->
        <section class="lp-features">
            <h2>Why Choose KisanConnect?</h2>
            <p>Experience the full power of our platform with these key features.</p>
            <div class="feature-card-container">

                <!-- Card 1: AI Assistant -->
                <div class="feature-card" onclick="this.classList.toggle('is-flipped')">
                    <div class="feature-card-face feature-card-front">
                        <div class="icon"></div>
                        <h3>AI-Powered Assistant</h3>
                        <p>Get AI-driven advice for your farm or find the perfect recipe for your purchase.</p>
                        <small style="margin-top: 2rem; color: var(--color-secondary);">Click to flip</small>
                    </div>
                    <div class="feature-card-face feature-card-back">
                        <h3>AI-Powered Assistant</h3>
                        <p>Our built-in AI helper assists farmers with pricing and listing optimization, and helps
                            customers with product info and recipes.</p>
                    </div>
                </div>

                <!-- Card 2: Location-Based -->
                <div class="feature-card" onclick="this.classList.toggle('is-flipped')">
                    <div class="feature-card-face feature-card-front">
                        <div class="icon"></div>
                        <h3>Location-Based Shopping</h3>
                        <p>Find the freshest produce from farmers right in your own neighborhood.</p>
                        <small style="margin-top: 2rem; color: var(--color-secondary);">Click to flip</small>
                    </div>
                    <div class="feature-card-face feature-card-back">
                        <h3>Location-Based Shopping</h3>
                        <p>Our platform prioritizes local connections. Customers can filter by location to buy from
                            nearby farmers, reducing food miles and supporting the community.</p>
                    </div>
                </div>

                <!-- Card 3: Order Management -->
                <div class="feature-card" onclick="this.classList.toggle('is-flipped')">
                    <div class="feature-card-face feature-card-front">
                        <div class="icon"></div>
                        <h3>Easy Farmer Management</h3>
                        <p>Farmers get simple tools to manage listings and track orders.</p>
                        <small style="margin-top: 2rem; color: var(--color-secondary);">Click to flip</small>
                    </div>
                    <div class="feature-card-face feature-card-back">
                        <h3>Easy Farmer Management</h3>
                        <p>A dedicated dashboard for farmers allows for easy product listing, price updates, and a
                            real-time view of incoming orders.</p>
                    </div>
                </div>

                <!-- Card 4: Direct Farm-to-Table (NEW) -->
                <div class="feature-card" onclick="this.classList.toggle('is-flipped')">
                    <div class="feature-card-face feature-card-front">
                        <div class="icon"></div>
                        <h3>Direct Farm-to-Table</h3>
                        <p>Eliminate the middlemen. Get produce harvested hours ago, not days.</p>
                        <small style="margin-top: 2rem; color: var(--color-secondary);">Click to flip</small>
                    </div>
                    <div class="feature-card-face feature-card-back">
                        <h3>Maximum Freshness</h3>
                        <p>By connecting directly with farmers, you ensure your food retains maximum nutrition and
                            flavor. No cold storage warehouses.</p>
                    </div>
                </div>

                <!-- Card 5: Fair Pricing (NEW) -->
                <div class="feature-card" onclick="this.classList.toggle('is-flipped')">
                    <div class="feature-card-face feature-card-front">
                        <div class="icon"></div>
                        <h3>Fair Pricing Model</h3>
                        <p>Farmers set their prices. You get the best deal without hidden markups.</p>
                        <small style="margin-top: 2rem; color: var(--color-secondary);">Click to flip</small>
                    </div>
                    <div class="feature-card-face feature-card-back">
                        <h3>Win-Win Economy</h3>
                        <p>Our platform empowers farmers to earn a fair wage while customers save money by skipping
                            retail chain markups.</p>
                    </div>
                </div>

                <!-- Card 6: Real-Time Tracking (NEW) -->
                <div class="feature-card" onclick="this.classList.toggle('is-flipped')">
                    <div class="feature-card-face feature-card-front">
                        <div class="icon"></div>
                        <h3>Real-Time Tracking</h3>
                        <p>Track your order status from the farm directly to your doorstep.</p>
                        <small style="margin-top: 2rem; color: var(--color-secondary);">Click to flip</small>
                    </div>
                    <div class="feature-card-face feature-card-back">
                        <h3>Transparent Delivery</h3>
                        <p>Stay informed with live status updates (Processing, Delivered, Cancelled) for a hassle-free
                            and transparent experience.</p>
                    </div>
                </div>

            </div>
        </section>

        <!-- Landing Page Stats -->
        <section class="lp-stats">
            <div class="container stats-grid">
                <div class="stat-item">
                    <h3>100+</h3>
                    <p>Local Farmers</p>
                </div>
                <div class="stat-item">
                    <h3>500+</h3>
                    <p>Fresh Products</p>
                </div>
                <div class="stat-item">
                    <h3>1000+</h3>
                    <p>Happy Customers</p>
                </div>
                <div class="stat-item">
                    <h3>24/7</h3>
                    <p>AI Support</p>
                </div>
            </div>
        </section>

        <!-- Landing Page CTA -->
        <section class="lp-cta">
            <div class="container">
                <h2>Ready to Get Started?</h2>
                <p>Join thousands of customers and farmers already using KisanConnect to trade fresh, local produce.</p>
                <button onclick="showLoginView()" class="lp-btn lp-btn-primary" style="font-size: 1.125rem;">
                    Start Shopping Now &rarr;
                </button>
            </div>
        </section>

        <!-- Landing Page Footer -->
        <footer class="lp-footer">
            <div class="container">
                <p>&copy; 2024 KisanConnect. A Friendly Farmer-Customer Interface.</p>
                <div style="display: flex; justify-content: center; gap: 1.5rem;">
                    <a href="#">About Us</a>
                    <a href="#">Farmer Login</a>
                    <a href="#">Support</a>
                </div>
            </div>
        </footer>
    </section>

    <!-- 2. LOGIN VIEW (Role Selection) -->
    <section id="loginView" class="login-page">
        <div class="login-card">
            <h1 data-i18n="welcome_msg">Welcome to KisanConnect</h1>
            <p style="font-size: 1.125rem; color: var(--color-text-light); margin-bottom: 2.5rem;">Select your role to
                proceed to the RaituBazar interface.</p>

            <div class="role-grid">

                <button onclick="showLoginForm('customer')" class="role-card customer-card">
                    <div class="icon"></div>
                    <h3 data-i18n="role_customer">Customer</h3>
                    <p style="color: var(--color-text-light); margin-top: 0.5rem;">Browse fresh produce and place
                        orders.</p>
                    <span data-i18n="nav_login">Log In / Sign Up</span>
                </button>

                <button onclick="showLoginForm('farmer')" class="role-card farmer-card">
                    <div class="icon"></div>
                    <h3 data-i18n="role_farmer">Farmer</h3>
                    <p style="color: var(--color-text-light); margin-top: 0.5rem;">Manage listings and view order
                        history.</p>
                    <span data-i18n="nav_login">Log In / Sign Up</span>
                </button>

            </div>
            <p id="authStatus" style="margin-top: 2rem; font-size: 0.875rem;">Authentication Ready (User ID: <span
                    id="currentUserIdDisplay">Loading...</span>)</p>
        </div>
    </section>

    <!-- NEW: Login Form Modal (Now with Register Tab) -->
    <div id="loginFormModal" class="modal-backdrop">
        <div class="modal-content" id="loginFormModalContent">

            <div class="auth-tabs">
                <div id="loginTab" class="auth-tab active" onclick="switchAuthTab('login')">Log In</div>
                <div id="registerTab" class="auth-tab" onclick="switchAuthTab('register')">Register</div>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="active" onsubmit="event.preventDefault(); handleLoginSubmit();">
                <h3 id="loginModalTitle">Login</h3>
                <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" id="loginEmail" required placeholder="e.g., user@example.com">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required placeholder="">
                </div>
                <button type="submit">Log In</button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" onsubmit="event.preventDefault(); handleRegisterSubmit();">
                <h3 id="registerModalTitle">Register</h3>
                <div class="form-group">
                    <label for="registerEmail">Email</label>
                    <input type="email" id="registerEmail" required placeholder="e.g., user@example.com">
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" required placeholder="Minimum 6 characters">
                </div>
                <button type="submit">Create Account</button>
            </form>

            <button onclick="closeLoginForm()" class="modal-btn cancel">Cancel</button>
        </div>
    </div>

    <!-- NEW: Edit Product Modal -->
    <div id="editProductModal" class="modal-backdrop">
        <div class="modal-content" id="editProductModalContent">
            <h3>Edit Product Listing</h3>
            <form id="editProductForm" onsubmit="event.preventDefault(); handleUpdateProduct();">
                <input type="hidden" id="editProductId"> <!-- Hidden field to store product ID -->
                <div class="form-group">
                    <label for="editProductName">Product Name</label>
                    <input type="text" id="editProductName" required>
                </div>
                <div class="form-group">
                    <label for="editProductPrice">Price ()</label>
                    <input type="number" id="editProductPrice" required step="0.01">
                </div>
                <!-- NEW: Stock Field in Edit -->
                <div class="form-group">
                    <label for="editProductStock">Quantity Available (kg/units)</label>
                    <input type="number" id="editProductStock" required min="0">
                </div>
                <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label for="editProductUnit">Unit</label>
                        <select id="editProductUnit" required>
                            <option value="per kg">per kg</option>
                            <option value="per bundle">per bundle</option>
                            <option value="per piece">per piece</option>
                            <option value="per dozen">per dozen</option>
                        </select>
                    </div>
                    <div>
                        <label for="editProductFreshness">Freshness Status</label>
                        <input type="text" id="editProductFreshness" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="editProductLocation">Farmer Location (City)</label>
                    <input type="text" id="editProductLocation" required placeholder="e.g., Tirupati">
                </div>
                <!-- MODIFIED: Back to URL input -->
                <div class="form-group">
                    <label for="editProductImage">New Image URL (Optional)</label>
                    <input type="url" id="editProductImage" placeholder="Keep blank to use existing">
                    <small>Paste a link to a new image from the web.</small>
                </div>

                <button type="submit" class="modal-btn success" id="editProductSubmitBtn">
                    Update Product
                </button>
                <button type="button" onclick="closeEditProductModal()" class="modal-btn cancel">Cancel</button>
            </form>
        </div>
    </div>


    <!-- 3. MAIN APPLICATION CONTAINER -->
    <main id="mainApp">
        <!-- Navigation Bar -->
        <header>
            <nav class="container">
                <div class="nav-left">
                    <a href="#" onclick="window.location.reload()" class="logo">KisanConnect</a>

                    <!-- NEW: Language Toggle (Main App) -->
                    <select class="lang-select" onchange="setLanguage(this.value)">
                        <option value="en">English</option>
                        <option value="te"></option>
                        <option value="hi"></option>
                    </select>

                    <!-- NEW: Dark Mode Toggle in Main App -->
                    <button id="themeToggleMain" class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">
                        <!-- Sun Icon -->
                        <svg class="sun-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="4" />
                            <path d="M12 2v2" />
                            <path d="M12 20v2" />
                            <path d="m4.93 4.93 1.41 1.41" />
                            <path d="m17.66 17.66 1.41 1.41" />
                            <path d="M2 12h2" />
                            <path d="M20 12h2" />
                            <path d="m6.34 17.66-1.41-1.41" />
                            <path d="m19.07 4.93-1.41 1.41" />
                        </svg>
                        <!-- Moon Icon -->
                        <svg class="moon-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round" style="display: none;">
                            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />
                        </svg>
                    </button>
                </div>

                <div class="nav-info">

                    <!-- NEW: Profile Button -->
                    <button onclick="toggleView('profile')" class="nav-link" data-i18n="nav_profile">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-user">
                            <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" />
                            <circle cx="12" cy="7" r="4" />
                        </svg>
                        Profile
                    </button>

                    <!-- Location Block - Now triggers the modal -->
                    <div id="locationBlock" onclick="showLocationModal()" title="Click to select location">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-map-pin">
                            <path d="M12 18s-4-6-4-8a4 4 0 0 1 8 0c0 2-4 8-4 8z" />
                            <circle cx="12" cy="10" r="1" />
                        </svg>
                        <span id="locationText">Location</span>
                    </div>

                    <div id="roleDisplay">Role: Customer</div>

                    <!-- Customer Links -->
                    <button onclick="toggleCustomerView('orders')" class="nav-link" id="ordersButton"
                        style="display: none;" data-i18n="nav_orders">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-history">
                            <path d="M3 3v5h5" />
                            <path d="M3.014 11a9 9 0 1 0 5.98-5.748" />
                            <path d="M12 7v5l4 2" />
                        </svg>
                        My Orders
                    </button>

                    <!-- NEW: Farmer Tools Dropdown -->
                    <div class="nav-dropdown" id="farmerToolsDropdown">
                        <button class="dropdown-trigger" onclick="toggleFarmerToolsDropdown()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path
                                    d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" />
                            </svg>
                            Farmer Tools
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round">
                                <path d="m6 9 6 6 6-6" />
                            </svg>
                        </button>
                        <div class="dropdown-menu">
                            <!-- My Listings -->
                            <button class="dropdown-item"
                                onclick="toggleFarmerView('listings'); closeFarmerToolsDropdown()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path
                                        d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
                                    <rect width="8" height="4" x="8" y="2" rx="1" ry="1" />
                                </svg>
                                My Listings
                            </button>
                            <!-- Orders Received -->
                            <button class="dropdown-item"
                                onclick="toggleFarmerView('orders'); closeFarmerToolsDropdown()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="m7.5 4.27 9 5.15" />
                                    <path
                                        d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z" />
                                    <path d="m3.3 7 8.7 5 8.7-5" />
                                    <path d="M12 22V12" />
                                </svg>
                                Orders Received
                            </button>

                            <div class="dropdown-divider"></div>

                            <!-- Growth Analytics -->
                            <button class="dropdown-item"
                                onclick="toggleFarmerView('growth'); closeFarmerToolsDropdown()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <polyline points="22 7 13.5 15.5 8.5 10.5 2 17" />
                                    <polyline points="16 7 22 7 22 13" />
                                </svg>
                                Growth Analytics
                            </button>
                            <!-- Crop Doctor -->
                            <button class="dropdown-item"
                                onclick="toggleFarmerView('crop-doctor'); closeFarmerToolsDropdown()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                                    <path d="m9 12 2 2 4-4" />
                                </svg>
                                AI Crop Doctor
                            </button>
                            <!-- Govt Schemes -->
                            <button class="dropdown-item"
                                onclick="toggleFarmerView('schemes'); closeFarmerToolsDropdown()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                    <polyline points="14 2 14 8 20 8" />
                                    <line x1="16" y1="13" x2="8" y2="13" />
                                    <line x1="16" y1="17" x2="8" y2="17" />
                                </svg>
                                Govt Schemes
                            </button>
                            <!-- Weather Forecast -->
                            <button class="dropdown-item"
                                onclick="toggleFarmerView('weather'); closeFarmerToolsDropdown()">
                                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z" />
                                </svg>
                                Weather Forecast
                            </button>
                        </div>
                    </div>

                    <div style="position: relative; display: none;" id="cartContainer">
                        <button id="cartButton" onclick="toggleCustomerView('cart')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="lucide lucide-shopping-cart">
                                <circle cx="8" cy="21" r="1" />
                                <circle cx="19" cy="21" r="1" />
                                <path
                                    d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.15" />
                            </svg>
                        </button>
                        <span id="cartCounter">0</span>
                    </div>

                    <!-- Sign Out Button (Now always visible when mainApp is active) -->
                    <button onclick="signOutUser()" class="signout-btn" data-i18n="nav_signout">
                        Sign Out
                    </button>
                </div>
            </nav>
        </header>

        <!-- Success/Error Message Modal -->
        <div id="messageBox" class="modal-backdrop">
            <div class="modal-content" id="messageContent">
                <h3 class="modal-title-success" style="font-size: 1.25rem; font-weight: 700; margin-bottom: 0.75rem;">
                    Success!</h3>
                <p id="messageText" style="color: var(--color-text-light); margin-bottom: 1rem;">Item added to your
                    basket.</p>
                <button onclick="closeMessage()" class="modal-btn success">
                    Close
                </button>
            </div>
        </div>

        <!-- NEW: Location Selection Modal -->
        <div id="locationModal" class="modal-backdrop">
            <div class="modal-content" id="locationModalContent">
                <h3 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem;">Select Your Location</h3>
                <p style="color: var(--color-text-light); margin-bottom: 1.5rem;">Choose how you want to set your
                    delivery area.</p>

                <!-- Option 1: Automatic Detection -->
                <div class="option-card" onclick="autoDetectLocation()">
                    <p style="font-weight: 700; color: #2563eb;"> Auto-Detect My Location</p>
                    <p style="font-size: 0.875rem; color: var(--color-text-light); margin-top: 0.25rem;">Use your
                        device's GPS for precise location finding.</p>
                </div>

                <p style="text-align: center; margin: 1rem 0; font-weight: 600; color: var(--color-text-light);">OR</p>

                <!-- Option 2: Manual Input -->
                <form
                    onsubmit="event.preventDefault(); manualSetLocation(document.getElementById('manualLocationInput').value);">
                    <label for="manualLocationInput"
                        style="font-weight: 700; color: var(--color-primary-dark);">Manually Enter City/Area
                        Name:</label>
                    <input type="text" id="manualLocationInput" placeholder="e.g., Tirupati, Hyderabad" required>
                    <button type="submit" class="set-location-btn">Set Location</button>
                </form>

                <button onclick="closeLocationModal()" class="modal-btn cancel">Cancel</button>
            </div>
        </div>

        <!-- Gemini LLM Modal (Kept for Farmer Optimization) -->
        <div id="llmModal" class="modal-backdrop">
            <div class="modal-content" id="llmContent"
                style="max-width: 512px; max-height: 90vh; overflow-y: auto; padding: 2rem 1.5rem;">
                <h3 id="llmModalTitle"
                    style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; display: flex; align-items: center; color: var(--color-text-dark);">
                    <span style="margin-right: 0.5rem;"></span> AI Insight
                </h3>
                <div id="llmOutput" style="color: var(--color-text-dark); line-height: 1.5;">
                    <div style="display: flex; justify-content: center; align-items: center; height: 12rem;"
                        id="llmLoading">
                        <div class="spinner" style="border-color: #8b5cf6;"></div>
                        <p style="margin-left: 1rem; color: #8b5cf6; font-weight: 600;">Generating AI analysis...</p>
                    </div>
                </div>
                <button onclick="closeLLMModal()" class="modal-btn llm-close" style="margin-top: 1.5rem;">
                    Close
                </button>
            </div>
        </div>

        <!-- 3A. CUSTOMER VIEW CONTAINER -->
        <div id="customerView" style="display: block;">

            <!-- MARKET PAGE -->
            <div id="marketPage" style="display: block;">
                <!-- Hero Section -->
                <section class="hero-section">
                    <div class="container">
                        <h1 data-i18n="hero_title">Directly from Our Farmers</h1>
                        <p data-i18n="hero_desc">
                            Connecting you to the freshest, locally-sourced produce, straight from the raitubazar to
                            your doorstep.
                        </p>
                        <div class="hero-buttons">
                            <button onclick="document.getElementById('products').scrollIntoView({behavior: 'smooth'})"
                                class="shop-btn" style="width: auto; min-width: 250px;" data-i18n="shop_now">
                                Shop Fresh Produce
                            </button>
                            <!-- Generate Recipe Button Removed -->
                        </div>
                    </div>
                </section>

                <!-- Product Grid Section -->
                <section id="products">
                    <div class="container">
                        <h2 data-i18n="market_title">Today's Fresh Harvest</h2>

                        <!-- New Filter and Sort Bar -->
                        <div id="filterBar">
                            <!-- NEW: Search Input with Voice Button -->
                            <div class="filter-group" style="flex: 1.5;">
                                <label for="searchInput" data-i18n="search_label">Search Product:</label>
                                <div style="display: flex; gap: 0.5rem; width: 100%;">
                                    <input type="text" id="searchInput" placeholder="e.g. Tomato, Mango..."
                                        oninput="debouncedFilterAndSort()">
                                    <button id="voiceSearchBtn" onclick="startVoiceSearch()" class="voice-btn"
                                        title="Voice Search">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round">
                                            <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z" />
                                            <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                                            <line x1="12" x2="12" y1="19" y2="22" />
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <div class="filter-group">
                                <label for="priceRange" data-i18n="filter_price">Max Price ():</label>
                                <input type="range" id="priceRange" min="10" max="250" value="250" step="10"
                                    oninput="updatePriceValue(this.value); debouncedFilterAndSort();">
                                <span id="priceRangeValue">250</span>
                            </div>

                            <!-- NEW: Location Filter -->
                            <div class="filter-group">
                                <label for="locationFilter" data-i18n="filter_loc">Location:</label>
                                <select id="locationFilter" onchange="filterAndSortProducts()">
                                    <option value="all">All Locations</option>
                                    <option value="my_location">My Location Only</option>
                                </select>
                            </div>

                            <div class="filter-group">
                                <label for="sortOrder" data-i18n="sort_by">Sort By:</label>
                                <select id="sortOrder" onchange="filterAndSortProducts()">
                                    <option value="timestamp_desc">Freshness (Newest First)</option>
                                    <option value="price_asc">Price (Low to High)</option>
                                    <option value="price_desc">Price (High to Low)</option>
                                    <option value="name_asc">Name (A-Z)</option>
                                </select>
                            </div>
                        </div>

                        <div id="productGrid" class="product-grid">
                            <!-- Product Cards will be injected here by JavaScript -->
                            <p style="text-align: center; color: var(--color-text-light); grid-column: 1 / -1; padding-top: 3rem;"
                                id="noProductsMessage">
                                Loading products or no products found in the market...
                            </p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- CART PAGE -->
            <div id="cartPage" style="display: none;">
                <div class="container">
                    <div class="orders-header">
                        <button onclick="toggleCustomerView('market')" class="back-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="lucide lucide-arrow-left">
                                <path d="m12 19-7-7 7-7" />
                                <path d="M19 12H5" />
                            </svg>
                            Back to Market
                        </button>
                        <h2 style="margin: 0;"> Your Shopping Basket</h2>
                        <span></span> <!-- Spacer -->
                    </div>

                    <div class="cart-layout">
                        <div id="cartItemsList">
                            <p class="empty-cart-message">Your basket is currently empty. Start adding some fresh
                                produce!</p>
                        </div>

                        <div class="cart-summary">
                            <h3
                                style="font-size: 1.25rem; font-weight: 700; color: var(--color-text-dark); margin-bottom: 1rem;">
                                Order Summary</h3>

                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <span id="cartSubtotal">0.00</span>
                            </div>
                            <div class="summary-row">
                                <span>GST (5%):</span>
                                <span id="cartTax">0.00</span>
                            </div>
                            <div class="summary-row">
                                <span>Total:</span>
                                <span id="cartGrandTotal">0.00</span>
                            </div>

                            <!-- Payment Method Selection -->
                            <div class="payment-methods"
                                style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--color-border);">
                                <p style="font-weight: 600; margin-bottom: 0.75rem; color: var(--color-text-dark);">
                                    Payment Method</p>
                                <div class="payment-options">
                                    <label class="payment-option">
                                        <input type="radio" name="paymentMethod" value="upi" checked>
                                        <span class="payment-label">
                                            <span class="payment-icon"></span>
                                            <span>UPI</span>
                                        </span>
                                    </label>
                                    <label class="payment-option">
                                        <input type="radio" name="paymentMethod" value="card">
                                        <span class="payment-label">
                                            <span class="payment-icon"></span>
                                            <span>Card</span>
                                        </span>
                                    </label>
                                    <label class="payment-option">
                                        <input type="radio" name="paymentMethod" value="netbanking">
                                        <span class="payment-label">
                                            <span class="payment-icon"></span>
                                            <span>Net Banking</span>
                                        </span>
                                    </label>
                                    <label class="payment-option">
                                        <input type="radio" name="paymentMethod" value="cod">
                                        <span class="payment-label">
                                            <span class="payment-icon"></span>
                                            <span>Cash on Delivery</span>
                                        </span>
                                    </label>
                                </div>
                            </div>

                            <button onclick="processPayment()" class="checkout-btn" id="checkoutBtn">
                                Proceed to Pay
                            </button>
                            <button onclick="toggleCustomerView('market')" class="modal-btn success"
                                style="margin-top: 0.5rem;">
                                Continue Shopping
                            </button>
                        </div>

                    </div>
                </div>
            </div>

            <!-- NEW: ORDERS PAGE -->
            <div id="ordersPage" style="display: none;">
                <div class="container">
                    <div class="orders-header">
                        <button onclick="toggleCustomerView('market')" class="back-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="lucide lucide-arrow-left">
                                <path d="m12 19-7-7 7-7" />
                                <path d="M19 12H5" />
                            </svg>
                            Back to Market
                        </button>
                        <h2 style="margin: 0;"> My Order History</h2>
                        <span></span> <!-- Spacer -->
                    </div>
                    <div id="ordersList">
                        <p style="text-align: center; color: var(--color-text-light); padding: 3rem;"
                            id="noOrdersMessage">
                            You haven't placed any orders yet. Start shopping!
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3B. FARMER VIEW (Product Selling Interface) -->
        <div id="farmerView" style="display: block;"> <!-- Keep this display: block for toggling -->

            <!-- NEW: Farmer Listings Page (Default) -->
            <div id="farmerListingsPage" style="display: block;">
                <div class="container">
                    <h2
                        style="font-size: 2rem; font-weight: 700; text-align: center; color: var(--color-primary-dark); padding-top: 2rem; margin-bottom: 1rem;">
                         Manage Your Farm Listings
                    </h2>
                    <p style="text-align: center; color: var(--color-text-light); margin-bottom: 2rem;">Use this form to
                        add a new product to the RaituBazar.</p>

                    <div class="farmer-form-card">
                        <!-- NEW: Progress Bar for Add Product -->
                        <div class="progress-wrapper">
                            <div class="progress-info">
                                <span>Completion Status</span>
                                <span id="addProductProgressText">0%</span>
                            </div>
                            <div class="progress-track">
                                <div id="addProductProgressBar" class="progress-fill"></div>
                            </div>
                        </div>

                        <form id="addProductForm" onsubmit="event.preventDefault(); addProduct();"
                            oninput="updateAddProductProgress()">
                            <div class="form-group">
                                <label for="productName">Product Name</label>
                                <input type="text" id="productName" required
                                    placeholder="e.g., Organic Turmeric, Tomatoes">
                            </div>
                            <div class="form-group">
                                <label for="productPrice">Price ()</label>
                                <input type="number" id="productPrice" required placeholder="e.g., 50.00" step="0.01">
                            </div>
                            <!-- NEW: Stock Input for Farmers -->
                            <div class="form-group">
                                <label for="productStock">Quantity Available (kg/units)</label>
                                <input type="number" id="productStock" required placeholder="e.g., 100" min="1">
                            </div>
                            <div class="form-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label for="productUnit">Unit</label>
                                    <select id="productUnit" required>
                                        <option value="per kg">per kg</option>
                                        <option value="per bundle">per bundle</option>
                                        <option value="per piece">per piece</option>
                                        <option value="per dozen">per dozen</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="productFreshness">Freshness Status</label>
                                    <input type="text" id="productFreshness" required
                                        placeholder="e.g., Harvested Today">
                                </div>
                            </div>
                            <!-- NEW: Farmer Location Input -->
                            <div class="form-group">
                                <label for="productLocation">Your Location (City)</label>
                                <input type="text" id="productLocation" required
                                    placeholder="e.g., Tirupati, Hyderabad">
                            </div>
                            <!-- MODIFIED: Back to URL input -->
                            <div class="form-group">
                                <label for="productImage">Image URL (Optional)</label>
                                <input type="url" id="productImage"
                                    placeholder="https://via.placeholder.com/400x300/...">
                                <small>Paste a link to an image from the web (e.g., Google Images).</small>
                            </div>

                            <button type="submit" class="submit-btn" id="addProductSubmitBtn">
                                Add Product to Market
                            </button>
                        </form>
                    </div>

                    <div style="text-align: center; margin-top: 2rem;">
                        <h3 style="font-size: 1.5rem; font-weight: 700; color: var(--color-primary-dark);">My Current
                            Listings</h3>
                        <p style="color: var(--color-text-light);">Listings added by user ID: <span
                                id="farmerIdDisplay">Loading...</span></p>
                    </div>
                    <!-- Container for Farmer's own listings -->
                    <div id="myListingsContainer">
                        <p id="noFarmerListings"
                            style="grid-column: 1 / -1; text-align: center; color: var(--color-text-light);">No products
                            currently listed by you.</p>
                    </div>
                </div>
            </div>

            <!-- NEW: Farmer Orders Page -->
            <div id="farmerOrdersPage" style="display: none;">
                <div class="container">
                    <div class="orders-header">
                        <button onclick="toggleFarmerView('listings')" class="back-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="lucide lucide-arrow-left">
                                <path d="m12 19-7-7 7-7" />
                                <path d="M19 12H5" />
                            </svg>
                            Back to My Listings
                        </button>
                        <h2 style="margin: 0;"> Orders Received</h2>
                        <span></span> <!-- Spacer -->
                    </div>

                    <!-- NEW: Farmer Metrics Dashboard -->
                    <div class="farmer-metrics-grid">
                        <div class="metric-card">
                            <h3><span id="metricEarnings">0.00</span></h3>
                            <p>Total Revenue</p>
                        </div>
                        <div class="metric-card">
                            <h3><span id="metricOrders">0</span></h3>
                            <p>Total Orders</p>
                        </div>
                        <div class="metric-card">
                            <h3><span id="metricPending">0</span></h3>
                            <p>Pending Actions</p>
                        </div>
                    </div>

                    <div id="farmerOrdersList">
                        <p style="text-align: center; color: var(--color-text-light); padding: 3rem;"
                            id="noFarmerOrdersMessage">
                            No active orders found for your products.
                        </p>
                        <!-- Farmer order cards will be injected here -->
                    </div>
                </div>
            </div>

            <!-- NEW: Farmer Growth Page -->
            <div id="farmerGrowthPage">
                <div class="container">
                    <div class="orders-header">
                        <button onclick="toggleFarmerView('listings')" class="back-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="lucide lucide-arrow-left">
                                <path d="m12 19-7-7 7-7" />
                                <path d="M19 12H5" />
                            </svg>
                            Back to My Listings
                        </button>
                        <h2 style="margin: 0;"> Business Growth</h2>
                        <span></span> <!-- Spacer -->
                    </div>

                    <div class="growth-header-card">
                        <h3>Weekly Revenue Growth</h3>
                        <div id="growthRateDisplay" class="growth-rate">Loading...</div>
                        <p id="growthComparisonText">Comparing last 7 days vs previous 7 days</p>
                    </div>

                    <div class="chart-container">
                        <canvas id="growthChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- NEW: AI Crop Doctor Page -->
            <div id="farmerCropDoctorPage">
                <div class="container" style="max-width: 800px;">
                    <div class="orders-header">
                        <button onclick="toggleFarmerView('listings')" class="back-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="lucide lucide-arrow-left">
                                <path d="m12 19-7-7 7-7" />
                                <path d="M19 12H5" />
                            </svg>
                            Back to Dashboard
                        </button>
                        <h2 style="margin: 0; color: var(--color-primary-dark);"> AI Crop Doctor</h2>
                        <span></span>
                    </div>

                    <p style="text-align: center; color: var(--color-text-light); margin-bottom: 2rem;">
                        Upload a photo of your crop. Our AI will identify diseases and suggest organic remedies.
                    </p>

                    <!-- Upload Area -->
                    <div class="upload-area" onclick="document.getElementById('cropInput').click()">
                        <input type="file" id="cropInput" accept="image/*" style="display: none;"
                            onchange="handleCropImageUpload(this)">
                        <span class="upload-icon"></span>
                        <h3 style="font-weight: 700; margin-bottom: 0.5rem; color: var(--color-text-dark);">Click to
                            Upload Photo</h3>
                        <p style="color: var(--color-text-light);">Supports JPG, PNG (Max 5MB)</p>
                    </div>

                    <!-- Preview Area -->
                    <div id="cropPreviewContainer" class="crop-preview-container">
                        <img id="cropPreviewImage" src="" alt="Crop Preview">
                    </div>

                    <!-- Analyze Button -->
                    <button id="analyzeCropBtn" onclick="analyzeCrop()" class="submit-btn"
                        style="display: none; margin-bottom: 2rem; background: var(--gradient-secondary);">
                         Analyze Crop Health
                    </button>

                    <!-- Results Area -->
                    <div id="diagnosisCard" class="diagnosis-card">
                        <div class="diagnosis-header">
                            <div
                                style="background-color: #dcfce7; padding: 0.75rem; border-radius: 50%; color: #16a34a;">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                                    <path d="m9 12 2 2 4-4" />
                                </svg>
                            </div>
                            <div>
                                <div class="diagnosis-title">Diagnosis Report</div>
                                <div style="font-size: 0.875rem; color: var(--color-text-light);">AI Analysis Result
                                </div>
                            </div>
                        </div>
                        <div id="diagnosisContent" style="line-height: 1.7; color: var(--color-text-dark);">
                            <!-- AI Content will go here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- NEW: AI Government Scheme Finder Page -->
            <div id="farmerSchemesPage">
                <div class="container" style="max-width: 900px;">
                    <div class="orders-header">
                        <button onclick="toggleFarmerView('listings')" class="back-button">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" class="lucide lucide-arrow-left">
                                <path d="m12 19-7-7 7-7" />
                                <path d="M19 12H5" />
                            </svg>
                            Back to Dashboard
                        </button>
                        <h2 style="margin: 0; color: var(--color-primary-dark);"> Govt Scheme Finder</h2>
                        <span></span>
                    </div>

                    <div class="scheme-emoji-header"></div>

                    <div class="scheme-form-card">
                        <h3>Find Government Schemes For You</h3>
                        <p>Answer a few questions and our AI will find relevant agricultural schemes, subsidies, and
                            benefits you may be eligible for.</p>

                        <form id="schemeFinderForm" onsubmit="event.preventDefault(); findGovernmentSchemes();">
                            <div class="form-group">
                                <label for="schemeState">Your State</label>
                                <select id="schemeState" required>
                                    <option value="">Select State</option>
                                    <option value="Andhra Pradesh">Andhra Pradesh</option>
                                    <option value="Telangana">Telangana</option>
                                    <option value="Karnataka">Karnataka</option>
                                    <option value="Tamil Nadu">Tamil Nadu</option>
                                    <option value="Maharashtra">Maharashtra</option>
                                    <option value="Gujarat">Gujarat</option>
                                    <option value="Rajasthan">Rajasthan</option>
                                    <option value="Uttar Pradesh">Uttar Pradesh</option>
                                    <option value="Madhya Pradesh">Madhya Pradesh</option>
                                    <option value="Punjab">Punjab</option>
                                    <option value="Haryana">Haryana</option>
                                    <option value="Bihar">Bihar</option>
                                    <option value="West Bengal">West Bengal</option>
                                    <option value="Odisha">Odisha</option>
                                    <option value="Kerala">Kerala</option>
                                    <option value="Assam">Assam</option>
                                    <option value="Chhattisgarh">Chhattisgarh</option>
                                    <option value="Jharkhand">Jharkhand</option>
                                    <option value="Uttarakhand">Uttarakhand</option>
                                    <option value="Himachal Pradesh">Himachal Pradesh</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="schemeLandSize">Land Holding Size</label>
                                <select id="schemeLandSize" required>
                                    <option value="">Select Land Size</option>
                                    <option value="Less than 1 hectare (Marginal Farmer)">Less than 1 hectare (Marginal
                                        Farmer)</option>
                                    <option value="1-2 hectares (Small Farmer)">1-2 hectares (Small Farmer)</option>
                                    <option value="2-4 hectares (Semi-Medium Farmer)">2-4 hectares (Semi-Medium Farmer)
                                    </option>
                                    <option value="4-10 hectares (Medium Farmer)">4-10 hectares (Medium Farmer)</option>
                                    <option value="More than 10 hectares (Large Farmer)">More than 10 hectares (Large
                                        Farmer)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="schemeCropType">Primary Crop Type</label>
                                <select id="schemeCropType" required>
                                    <option value="">Select Crop Type</option>
                                    <option value="Paddy/Rice">Paddy/Rice</option>
                                    <option value="Wheat">Wheat</option>
                                    <option value="Cotton">Cotton</option>
                                    <option value="Sugarcane">Sugarcane</option>
                                    <option value="Pulses (Dal)">Pulses (Dal)</option>
                                    <option value="Oilseeds (Groundnut, Mustard)">Oilseeds (Groundnut, Mustard)</option>
                                    <option value="Vegetables">Vegetables</option>
                                    <option value="Fruits (Mango, Banana, etc.)">Fruits (Mango, Banana, etc.)</option>
                                    <option value="Spices (Chilli, Turmeric)">Spices (Chilli, Turmeric)</option>
                                    <option value="Millets (Jowar, Bajra, Ragi)">Millets (Jowar, Bajra, Ragi)</option>
                                    <option value="Mixed/Multiple Crops">Mixed/Multiple Crops</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="schemeCategory">Farmer Category (Optional)</label>
                                <select id="schemeCategory">
                                    <option value="General">General</option>
                                    <option value="SC/ST">SC/ST</option>
                                    <option value="OBC">OBC</option>
                                    <option value="Women Farmer">Women Farmer</option>
                                    <option value="Young Farmer (Below 35)">Young Farmer (Below 35)</option>
                                </select>
                            </div>

                            <button type="submit" class="submit-btn" id="findSchemesBtn"
                                style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                                 Find Schemes For Me
                            </button>
                        </form>
                    </div>

                    <!-- Results Card -->
                    <div id="schemeResultsCard" class="scheme-results-card">
                        <div class="scheme-results-header">
                            <div class="icon-circle">
                                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24"
                                    fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                    <polyline points="14 2 14 8 20 8" />
                                    <line x1="16" y1="13" x2="8" y2="13" />
                                    <line x1="16" y1="17" x2="8" y2="17" />
                                </svg>
                            </div>
                            <div>
                                <div class="scheme-results-title">Eligible Schemes</div>
                                <div style="font-size: 0.875rem; color: var(--color-text-light);">AI-Generated
                                    Recommendations</div>
                            </div>
                        </div>
                        <div id="schemeResultsContent">
                            <!-- AI Content will be rendered here -->
                        </div>
                        <p
                            style="margin-top: 1.5rem; font-size: 0.8rem; color: var(--color-text-light); text-align: center;">
                             Disclaimer: This information is AI-generated. Please verify details with official
                            government sources before applying.
                        </p>
                    </div>
                </div>
            </div>

        </div>

        <!-- NEW: Weather Forecast Page -->
        <div id="farmerWeatherPage">
            <div class="container weather-container">
                <div class="weather-header">
                    <h2> Weather Forecast</h2>
                    <p>7-day weather forecast to help you plan your farming activities</p>
                    <div class="weather-location" id="weatherLocation">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 18s-4-6-4-8a4 4 0 0 1 8 0c0 2-4 8-4 8z" />
                            <circle cx="12" cy="10" r="1" />
                        </svg>
                        <span id="weatherLocationText">Loading location...</span>
                    </div>
                </div>

                <!-- Weather Content Container -->
                <div id="weatherContent">
                    <div class="weather-loading">
                        <div class="spinner" style="border-color: #0ea5e9;"></div>
                        <p style="margin-top: 1rem; color: var(--color-text-light);">Fetching weather data...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW: PROFILE PAGE (For Both Roles) -->
        <div id="profilePage">
            <div class="container profile-container">

                <!-- FIX 1: Added Back Button to Profile Header -->
                <div class="orders-header">
                    <button onclick="toggleView('main')" class="back-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="lucide lucide-arrow-left">
                            <path d="m12 19-7-7 7-7" />
                            <path d="M19 12H5" />
                        </svg>
                        Back to Dashboard
                    </button>
                    <span></span> <!-- Spacer for alignment -->
                </div>

                <div class="profile-header">
                    <h2 id="profileTitle">My Profile</h2>
                    <p style="color: var(--color-text-light);">Manage your personal information and preferences.</p>
                </div>

                <div class="profile-card">
                    <!-- NEW: Progress Bar for Profile -->
                    <div class="progress-wrapper">
                        <div class="progress-info">
                            <span>Profile Strength</span>
                            <span id="profileProgressText">0%</span>
                        </div>
                        <div class="progress-track">
                            <div id="profileProgressBar" class="progress-fill"></div>
                        </div>
                    </div>

                    <form id="profileForm" onsubmit="event.preventDefault(); saveUserProfile();"
                        oninput="updateProfileProgress()">
                        <div class="profile-section-title">Personal Information</div>
                        <div class="form-group">
                            <label for="profileName">Full Name</label>
                            <input type="text" id="profileName" required placeholder="e.g., John Doe">
                        </div>
                        <div class="form-group">
                            <label for="profilePhone">Phone Number</label>
                            <input type="tel" id="profilePhone" placeholder="e.g., +91 98765 43210">
                        </div>

                        <!-- Fields for Farmer Only -->
                        <div id="farmerProfileFields" style="display: none;">
                            <div class="profile-section-title">Farm Details</div>
                            <div class="form-group">
                                <label for="profileFarmName">Farm Name</label>
                                <input type="text" id="profileFarmName" placeholder="e.g., Green Valley Organic Farm">
                            </div>
                            <div class="form-group">
                                <label for="profileFarmLocation">City / Location</label>
                                <input type="text" id="profileFarmLocation" placeholder="e.g., Tirupati">
                                <small>This will be used to auto-fill your product listings.</small>
                            </div>
                            <div class="form-group">
                                <label for="profileUPI">UPI ID (For Payments)</label>
                                <input type="text" id="profileUPI" placeholder="e.g., user@upi">
                            </div>
                        </div>

                        <!-- Fields for Customer Only -->
                        <div id="customerProfileFields" style="display: none;">
                            <div class="profile-section-title">Delivery Address</div>
                            <div class="form-group">
                                <label for="profileAddress">Street Address</label>
                                <input type="text" id="profileAddress" placeholder="e.g., 123 Main St, Near Temple">
                            </div>
                            <div class="form-group">
                                <label for="profileCity">City</label>
                                <input type="text" id="profileCity" placeholder="e.g., Tirupati">
                            </div>
                        </div>

                        <button type="submit" class="submit-btn" style="margin-top: 2rem;">Save Profile</button>
                        <!-- FIX 3: Changed 'renderView' to 'toggleView' to prevent app reset/crash -->
                        <button type="button" onclick="toggleView('main')" class="modal-btn cancel"
                            style="margin-top: 1rem; background-color: var(--color-card-bg); color: var(--color-text-dark); border: 1px solid var(--color-border);">Cancel</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Footer (Shared by all main views) -->
        <footer class="lp-footer" style="margin-top: 4rem;">
            <div class="container">
                <p>&copy; 2024 KisanConnect. A Friendly Farmer-Customer Interface. (User ID: <span
                        id="footerUserId"></span>)</p>
                <div style="display: flex; justify-content: center; gap: 1.5rem;">
                    <a href="#">About Us</a>
                    <a href="#">Farmer Login</a>
                    <a href="#">Support</a>
                </div>
            </div>
        </footer>
    </main>

    <!-- NEW: AI Chatbot Container -->
    <div id="chatContainer" style="display: none;">
        <button id="chatToggleBtn" onclick="toggleChat()">
            <!-- Chat Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="lucide lucide-message-square">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
            </svg>
        </button>

        <div id="chatWindow" class="">
            <div id="chatHeader">
                <span>KisanConnect AI Helper</span>
            </div>
            <div id="chatMessages">
                <!-- Messages will be rendered here -->
                <div class="chat-message gemini-message">
                    <p>Hello! I'm the KisanConnect AI. I can assist you with product info, ordering, or farming advice
                        based on your current role.</p>
                </div>
            </div>
            <div id="chatInputContainer">
                <input type="text" id="chatInput" placeholder="Ask me anything..."
                    onkeydown="if(event.key === 'Enter') sendMessage()">
                <button id="chatSendBtn" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>


    <!-- JavaScript for Data & Interactivity -->
    <script type="module">
        // --- Firebase Imports (using CDN) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // MODIFIED: Consolidated imports (added increment for atomic operations)
        import {
            getFirestore, collection, doc, setDoc, addDoc, onSnapshot,
            query, where, deleteDoc, updateDoc, getDoc, increment
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Modal Utility Function ---
        window.closeMessage = function () {
            const messageContent = document.getElementById('messageContent');
            if (messageContent) {
                messageContent.style.transform = 'scale(0.95)';
                messageContent.style.opacity = '0';
            }
            setTimeout(() => { document.getElementById('messageBox').style.display = 'none'; }, 300);
        }

        window.showMessage = function (text, type) {
            const messageBox = document.getElementById('messageBox');
            const messageContent = document.getElementById('messageContent');
            const messageText = document.getElementById('messageText');
            const modalTitle = document.querySelector('.modal-title-success');
            const modalBtn = document.querySelector('.modal-btn.success');

            messageText.textContent = text;

            if (type === 'error') {
                modalTitle.textContent = 'Oops!';
                modalTitle.style.color = 'var(--color-danger)';
                modalBtn.style.backgroundColor = 'var(--color-danger)';
            } else { // 'success' or default
                modalTitle.textContent = 'Success!';
                modalTitle.style.color = 'var(--color-primary-dark)';
                modalBtn.style.backgroundColor = 'var(--color-primary-dark)';
            }

            messageBox.style.display = 'flex';
            setTimeout(() => {
                messageContent.style.transform = 'scale(1)';
                messageContent.style.opacity = '1';
            }, 50);
        }

        // --- Gemini API Configuration ---
        const apiKey = "AIzaSyCm_nDTXpSESatW4A0rWxgod4-TGf8aHa8"; // API key will be provided by the environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const MAX_RETRIES = 5;

        // --- Global State & Firebase Setup ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app = null, db = null, auth = null;
        let currentUserId = null;
        let currentUserRole = null;
        let selectedRoleForLogin = null;
        let cart = [];
        let products = [];
        let rawProducts = [];
        let farmerListings = [];
        let orders = [];
        let chatHistory = [];
        let userLocation = { city: 'Unknown', coords: null };
        let isFirstFarmerLoad = true;
        let farmerAnalyticsData = [];

        // Determine which config to use
        const isHostedEnvironment = typeof __firebase_config !== 'undefined' && __firebase_config.length > 2;
        let firebaseConfig = {};

        // --- START LOCAL CONFIGURATION BLOCK ---
        const localFirebaseConfig = {
            apiKey: "AIzaSyCdk1C-AKuv-IkvxPHDIYR7m8mso7Z3wLI",
            authDomain: "kissanconnect-96f0e.firebaseapp.com",
            projectId: "kissanconnect-96f0e",
            storageBucket: "kissanconnect-96f0e.firebasestorage.app",
            messagingSenderId: "744411301115",
            appId: "1:744411301115:web:008d1376acd641dc1c9c5e",
            measurementId: "G-L7L36N5V7V"
        };
        // --- END LOCAL CONFIGURATION BLOCK ---

        if (isHostedEnvironment) {
            firebaseConfig = JSON.parse(__firebase_config);
        } else if (localFirebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
            firebaseConfig = localFirebaseConfig;
            console.warn("Using user-provided local config.");
        } else {
            firebaseConfig = localFirebaseConfig;
            console.warn("Local Mock Mode.");
        }

        // --- Initialization and View Logic ---
        async function initApp() {
            setLogLevel('Debug');

            const storedTheme = localStorage.getItem('kisanTheme');
            if (storedTheme === 'dark') {
                setTheme('dark');
            } else if (!storedTheme && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                setTheme('dark');
            }

            const storedLang = localStorage.getItem('kisanLang') || 'en';
            setLanguage(storedLang);

            const isConfigValid = firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE";

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);

                if (isHostedEnvironment || isConfigValid) {
                    db = getFirestore(app);
                } else {
                    db = null;
                }

                await checkAuthState();

            } catch (error) {
                console.error("Firebase Initialization FAILED:", error);
                currentUserId = 'error-' + Math.random().toString(36).substring(2, 6);
                renderView('landing');
            }

            document.getElementById('locationText').textContent = 'Select Location';
        }

        async function checkAuthState() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;

                    if (!currentUserRole) {
                        const storedRole = localStorage.getItem('kisanRole');
                        if (storedRole) {
                            currentUserRole = storedRole;
                        }
                    }

                    if (currentUserRole) {
                        renderView('main');
                    } else {
                        renderView('landing');
                    }
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                            await signInAnonymously(auth);
                        } else {
                            throw new Error("Mock config or invalid key, skipping sign-in.");
                        }
                    } catch (e) {
                        console.warn("Auth sign-in attempt failed or skipped:", e.message);
                        currentUserId = 'auth-fail-' + Math.random().toString(36).substring(2, 6);
                        renderView('landing');
                    }
                }
            });
        }

        window.showLoginView = function () {
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('loginView').style.display = 'flex';

            const authStatus = document.getElementById('authStatus');
            const isConfigPlaceholder = localFirebaseConfig.apiKey === "YOUR_API_KEY_HERE";

            if (db) {
                authStatus.textContent = `Authentication Ready (User ID: ${currentUserId}). Database is ON.`;
                authStatus.style.color = 'var(--color-primary-dark)';
            } else if (isConfigPlaceholder && !isHostedEnvironment) {
                authStatus.textContent = `Local Mock Mode (User ID: ${currentUserId}). Database is OFF.`;
                authStatus.style.color = 'var(--color-danger)';
            } else {
                authStatus.textContent = `Authentication failed. (User ID: ${currentUserId}). Database is OFF.`;
                authStatus.style.color = '#f59e0b';
            }
        }

        window.toggleView = function (viewName) {
            const customerView = document.getElementById('customerView');
            const farmerView = document.getElementById('farmerView');
            const profilePage = document.getElementById('profilePage');

            customerView.style.display = 'none';
            farmerView.style.display = 'none';
            profilePage.style.display = 'none';

            customerView.classList.remove('animate-fade-in');
            farmerView.classList.remove('animate-fade-in');
            profilePage.classList.remove('animate-fade-in');

            if (viewName === 'profile') {
                profilePage.style.display = 'block';
                profilePage.classList.add('animate-fade-in');
                loadUserProfile();
            } else if (viewName === 'main') {
                if (currentUserRole === 'customer') {
                    customerView.style.display = 'block';
                    customerView.classList.add('animate-fade-in');
                    toggleCustomerView('market');
                } else {
                    farmerView.style.display = 'block';
                    farmerView.classList.add('animate-fade-in');
                    toggleFarmerView('listings');
                }
            }
        }

        window.renderView = function (view) {
            document.getElementById('loadingIndicator').style.display = 'none';

            const landingPage = document.getElementById('landingPage');
            const loginView = document.getElementById('loginView');
            const mainApp = document.getElementById('mainApp');
            const chatContainer = document.getElementById('chatContainer');

            if (view === 'main') {
                landingPage.style.display = 'none';
                loginView.style.display = 'none';
                mainApp.style.display = 'block';
                chatContainer.style.display = 'block';

                chatHistory = [];
                chatHistory.push({
                    role: "model",
                    parts: [{ text: "Hello! I'm the KisanConnect AI. I can assist you with product info, ordering, or farming advice based on your current role." }]
                });

                document.getElementById('chatMessages').innerHTML = '';
                renderMessage("Hello! I'm the KisanConnect AI. I can assist you with product info, ordering, or farming advice based on your current role.", "gemini");

                document.getElementById('roleDisplay').textContent = `Role: ${currentUserRole}`;
                document.getElementById('footerUserId').textContent = currentUserId;

                toggleView('main');

                if (currentUserRole === 'farmer') {
                    document.getElementById('farmerProfileFields').style.display = 'block';
                    document.getElementById('customerProfileFields').style.display = 'none';
                    document.getElementById('ordersButton').style.display = 'none';
                    document.getElementById('farmerToolsDropdown').style.display = 'block'; // NEW: Show Farmer Tools dropdown
                    document.getElementById('cartContainer').style.display = 'none';
                    document.getElementById('farmerIdDisplay').textContent = currentUserId;
                    setupFarmerListingsListener();
                    setupFarmerOrdersListener();
                } else {
                    document.getElementById('farmerProfileFields').style.display = 'none';
                    document.getElementById('customerProfileFields').style.display = 'block';
                    document.getElementById('ordersButton').style.display = 'flex';
                    document.getElementById('farmerToolsDropdown').style.display = 'none'; // NEW: Hide Farmer Tools dropdown
                    document.getElementById('cartContainer').style.display = 'block';
                    setupProductListener();
                    setupOrderListener();
                }

            } else if (view === 'login') {
                showLoginView();
            } else {
                landingPage.style.display = 'block';
                mainApp.style.display = 'none';
                chatContainer.style.display = 'none';
                loginView.style.display = 'none';
                currentUserRole = null;
            }
        }

        window.toggleCustomerView = function (page) {
            const marketPage = document.getElementById('marketPage');
            const cartPage = document.getElementById('cartPage');
            const ordersPage = document.getElementById('ordersPage');

            marketPage.style.display = 'none';
            cartPage.style.display = 'none';
            ordersPage.style.display = 'none';
            document.getElementById('profilePage').style.display = 'none';

            marketPage.classList.remove('animate-fade-in');
            cartPage.classList.remove('animate-fade-in');
            ordersPage.classList.remove('animate-fade-in');

            let activePage;
            if (page === 'cart') {
                cartPage.style.display = 'block';
                activePage = cartPage;
                renderCartPage();
            } else if (page === 'orders') {
                ordersPage.style.display = 'block';
                activePage = ordersPage;
            } else {
                marketPage.style.display = 'block';
                activePage = marketPage;
            }
            void activePage.offsetWidth;
            activePage.classList.add('animate-fade-in');
        }

        window.toggleFarmerView = function (page) {
            const farmerListingsPage = document.getElementById('farmerListingsPage');
            const farmerOrdersPage = document.getElementById('farmerOrdersPage');
            const farmerGrowthPage = document.getElementById('farmerGrowthPage');
            const farmerCropDoctorPage = document.getElementById('farmerCropDoctorPage');
            const farmerSchemesPage = document.getElementById('farmerSchemesPage');
            const farmerWeatherPage = document.getElementById('farmerWeatherPage'); // NEW: Weather page

            farmerListingsPage.style.display = 'none';
            farmerOrdersPage.style.display = 'none';
            farmerGrowthPage.style.display = 'none';
            farmerCropDoctorPage.style.display = 'none';
            farmerSchemesPage.style.display = 'none';
            farmerWeatherPage.style.display = 'none'; // NEW
            document.getElementById('profilePage').style.display = 'none';

            farmerListingsPage.classList.remove('animate-fade-in');
            farmerOrdersPage.classList.remove('animate-fade-in');
            farmerGrowthPage.classList.remove('animate-fade-in');
            farmerCropDoctorPage.classList.remove('animate-fade-in');
            farmerSchemesPage.classList.remove('animate-fade-in');
            farmerWeatherPage.classList.remove('animate-fade-in'); // NEW

            let activePage;
            if (page === 'orders') {
                farmerOrdersPage.style.display = 'block';
                activePage = farmerOrdersPage;
            } else if (page === 'growth') {
                farmerGrowthPage.style.display = 'block';
                activePage = farmerGrowthPage;
                renderGrowthChart();
            } else if (page === 'crop-doctor') {
                farmerCropDoctorPage.style.display = 'block';
                activePage = farmerCropDoctorPage;
            } else if (page === 'schemes') {
                farmerSchemesPage.style.display = 'block';
                activePage = farmerSchemesPage;
            } else if (page === 'weather') { // NEW: Weather page toggle
                farmerWeatherPage.style.display = 'block';
                activePage = farmerWeatherPage;
                fetchWeatherData(); // Fetch weather when page opens
            } else {
                farmerListingsPage.style.display = 'block';
                activePage = farmerListingsPage;
            }
            void activePage.offsetWidth;
            activePage.classList.add('animate-fade-in');
        }

        // --- NEW: Farmer Tools Dropdown Functions ---
        window.toggleFarmerToolsDropdown = function () {
            const dropdown = document.getElementById('farmerToolsDropdown');
            dropdown.classList.toggle('open');
        }

        window.closeFarmerToolsDropdown = function () {
            const dropdown = document.getElementById('farmerToolsDropdown');
            dropdown.classList.remove('open');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (event) {
            const dropdown = document.getElementById('farmerToolsDropdown');
            if (dropdown && !dropdown.contains(event.target)) {
                dropdown.classList.remove('open');
            }
        });


        // --- LOGIN / REGISTRATION ---

        window.switchAuthTab = function (tab) {
            const loginTab = document.getElementById('loginTab');
            const registerTab = document.getElementById('registerTab');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');

            if (tab === 'login') {
                loginTab.classList.add('active');
                registerTab.classList.remove('active');
                loginForm.classList.add('active');
                registerForm.classList.remove('active');
            } else {
                loginTab.classList.remove('active');
                registerTab.classList.add('active');
                loginForm.classList.remove('active');
                registerForm.classList.add('active');
            }
            document.getElementById('loginModalTitle').textContent = `Login as ${selectedRoleForLogin}`;
            document.getElementById('registerModalTitle').textContent = `Register as ${selectedRoleForLogin}`;
        }

        window.showLoginForm = function (role) {
            if (role !== 'customer' && role !== 'farmer') return;
            selectedRoleForLogin = role;

            switchAuthTab('login');

            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerPassword').value = '';

            const modal = document.getElementById('loginFormModal');
            modal.style.display = 'flex';
            setTimeout(() => {
                document.getElementById('loginFormModalContent').style.transform = 'scale(1)';
                document.getElementById('loginFormModalContent').style.opacity = '1';
            }, 50);
        }

        window.closeLoginForm = function () {
            const content = document.getElementById('loginFormModalContent');
            content.style.transform = 'scale(0.95)';
            content.style.opacity = '0';
            setTimeout(() => { document.getElementById('loginFormModal').style.display = 'none'; }, 300);
            selectedRoleForLogin = null;
        }

        window.handleRegisterSubmit = async function () {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            if (!auth) {
                showMessage("Authentication service is not ready. Please try again.", 'error');
                return;
            }
            if (password.length < 6) {
                showMessage("Password must be at least 6 characters long.", 'error');
                return;
            }

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                currentUserRole = selectedRoleForLogin;
                currentUserId = user.uid;

                localStorage.setItem('kisanRole', currentUserRole);

                closeLoginForm();
                showMessage(`Welcome! Account created as ${currentUserRole}.`, 'success');
                renderView('main');

            } catch (error) {
                console.error("Firebase Register Error:", error.code, error.message);
                let errorMessage = "Registration failed. Please try again.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "This email address is already in use.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Please enter a valid email address.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Your password is too weak. Please choose a stronger one.";
                }
                showMessage(errorMessage, 'error');
            }
        }

        window.handleLoginSubmit = async function () {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!auth) {
                showMessage("Authentication service is not ready. Please try again.", 'error');
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;

                currentUserRole = selectedRoleForLogin;
                currentUserId = user.uid;

                localStorage.setItem('kisanRole', currentUserRole);

                closeLoginForm();
                showMessage(`Welcome back! Logged in as ${currentUserRole}.`, 'success');
                renderView('main');

            } catch (error) {
                console.error("Firebase Login Error:", error.code, error.message);
                let errorMessage = "Login failed. Please check your email and password.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage = "Invalid email or password provided.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "Please enter a valid email address.";
                }
                showMessage(errorMessage, 'error');
            }
        }


        // --- SIGN OUT LOGIC ---
        window.signOutUser = function () {
            if (auth && auth.currentUser) {
                signOut(auth).then(() => {
                    console.log("[Auth] User signed out.");
                    currentUserId = null;
                    currentUserRole = null;
                    selectedRoleForLogin = null;
                    cart = [];
                    products = [];
                    rawProducts = [];
                    farmerListings = [];
                    orders = [];
                    chatHistory = [];
                    isFirstFarmerLoad = true;

                    localStorage.removeItem('kisanRole');

                    updateCartCount();
                    renderView('landing');
                }).catch((error) => {
                    console.error("[Auth] Error signing out:", error);
                    showMessage("Error signing out. Please try again.", 'error');
                });
            } else {
                currentUserId = null;
                currentUserRole = null;
                isFirstFarmerLoad = true;

                localStorage.removeItem('kisanRole');

                cart = []; products = []; rawProducts = []; farmerListings = []; orders = [];
                updateCartCount();
                renderView('landing');
            }
        }


        // --- GEOLOCATION LOGIC ---
        const OPENCAGE_API_KEY = "46eaeb0df34a4ef6ac4ed5eae238a0d9";

        async function reverseGeocode(lat, lon) {
            if (!OPENCAGE_API_KEY) {
                console.warn("OpenCage API Key is missing. Returning mock location.");
                return 'Mock Location';
            }
            const url = `https://api.opencagedata.com/geocode/v1/json?q=${lat}+${lon}&key=${OPENCAGE_API_KEY}`;
            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    const components = data.results[0].components;
                    const city = components.city || components.town || components.village || components.county || components.state_district || 'Area';
                    return city;
                }
                return 'Unknown Area';
            } catch (error) {
                console.error("Reverse Geocoding failed:", error);
                return 'Network Error';
            }
        }

        function handleGeolocationSuccess(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            userLocation.coords = { lat, lon };
            document.getElementById('locationText').textContent = 'Fetching Area...';

            closeLocationModal();

            if (!OPENCAGE_API_KEY) {
                userLocation.city = 'Local Demo Area';
                document.getElementById('locationText').textContent = userLocation.city;
                showMessage(`Location set to 'Local Demo Area'.`, 'success');
                filterAndSortProducts();
                return;
            }

            reverseGeocode(lat, lon).then(city => {
                userLocation.city = city;
                document.getElementById('locationText').textContent = city;
                showMessage(`Location set to ${city} via Auto-Detect.`, 'success');
                filterAndSortProducts();
            }).catch(() => {
                userLocation.city = 'Area Found';
                document.getElementById('locationText').textContent = 'Area Found';
                showMessage(`Location set to generic area. Geocoding failed.`, 'error');
            });
        }

        function handleGeolocationError(error) {
            console.warn('Geolocation Error:', error.code, error.message);
            closeLocationModal();
            userLocation.city = 'Location Disabled';
            document.getElementById('locationText').textContent = 'Location Disabled';
            showMessage('Please enable location services and try again.', 'error');
        }

        window.showLocationModal = function () {
            const modal = document.getElementById('locationModal');
            modal.style.display = 'flex';
            setTimeout(() => {
                document.getElementById('locationModalContent').style.transform = 'scale(1)';
                document.getElementById('locationModalContent').style.opacity = '1';
            }, 50);
        }

        window.closeLocationModal = function () {
            document.getElementById('locationModalContent').style.transform = 'scale(0.95)';
            document.getElementById('locationModalContent').style.opacity = '0';
            setTimeout(() => { document.getElementById('locationModal').style.display = 'none'; }, 300);
        }

        window.manualSetLocation = function (cityName) {
            if (!cityName || cityName.trim() === '') {
                showMessage('Please enter a valid city or area name.', 'error');
                return;
            }
            userLocation.city = cityName.trim();
            document.getElementById('locationText').textContent = cityName.trim();

            closeLocationModal();
            showMessage(`Location manually set to ${cityName.trim()}.`, 'success');

            filterAndSortProducts();
        }

        window.autoDetectLocation = function () {
            setTimeout(() => {
                if (navigator.geolocation) {
                    document.getElementById('locationText').textContent = 'Detecting...';
                    navigator.geolocation.getCurrentPosition(handleGeolocationSuccess, handleGeolocationError, {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    });
                } else {
                    closeLocationModal();
                    userLocation.city = 'Geo Not Supported';
                    document.getElementById('locationText').textContent = 'Geo Not Supported';
                    showMessage('Your browser does not support Geolocation.', 'error');
                }
            }, 50);
        }


        // --- CUSTOMER LOGIC: REAL-TIME DATA LISTENER & FILTERING ---
        function debounce(func, delay) {
            let timeoutId;
            return function (...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }

        window.debouncedFilterAndSort = debounce(filterAndSortProducts, 200);

        window.updatePriceValue = function (value) {
            document.getElementById('priceRangeValue').textContent = `${value}`;
        }

        // MODIFIED: Updated filter logic to include search text
        function filterAndSortProducts() {
            let filteredProducts = [...rawProducts];

            // 1. Filter by Search Text (NEW)
            const searchInput = document.getElementById('searchInput');
            if (searchInput && searchInput.value.trim() !== '') {
                const searchTerm = searchInput.value.toLowerCase().trim();
                filteredProducts = filteredProducts.filter(p => p.name.toLowerCase().includes(searchTerm));
            }

            // 2. Filter by Price
            const maxPrice = parseFloat(document.getElementById('priceRange').value);
            filteredProducts = filteredProducts.filter(p => p.price <= maxPrice);

            // 3. Filter by Location 
            const locationFilter = document.getElementById('locationFilter').value;
            if (locationFilter === 'my_location' && userLocation.city && userLocation.city !== 'Unknown' && userLocation.city !== 'Select Location') {
                filteredProducts = filteredProducts.filter(p =>
                    p.farmerLocation && p.farmerLocation.toLowerCase() === userLocation.city.toLowerCase()
                );
            }

            // 4. Sort
            const sortOrder = document.getElementById('sortOrder').value;
            filteredProducts.sort((a, b) => {
                switch (sortOrder) {
                    case 'price_asc': return a.price - b.price;
                    case 'price_desc': return b.price - a.price;
                    case 'name_asc': return a.name.localeCompare(b.name);
                    case 'timestamp_desc':
                        const timeA = a.timestamp ? new Date(a.timestamp).getTime() : 0;
                        const timeB = b.timestamp ? new Date(b.timestamp).getTime() : 0;
                        return timeB - timeA;
                    default: return 0;
                }
            });

            products = filteredProducts;
            renderProducts();
        }

        // NEW: Voice Search Functionality
        window.startVoiceSearch = function () {
            // Check browser support
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

            if (!SpeechRecognition) {
                showMessage("Voice search is not supported in this browser. Please use Google Chrome or Edge.", 'error');
                return;
            }

            const recognition = new SpeechRecognition();

            // Set language based on app preference
            const currentLang = localStorage.getItem('kisanLang') || 'en';
            if (currentLang === 'hi') recognition.lang = 'hi-IN';
            else if (currentLang === 'te') recognition.lang = 'te-IN';
            else recognition.lang = 'en-US'; // Default to English

            const btn = document.getElementById('voiceSearchBtn');
            const searchInput = document.getElementById('searchInput');

            recognition.onstart = function () {
                btn.classList.add('listening');
                searchInput.placeholder = "Listening...";
            };

            recognition.onresult = function (event) {
                const transcript = event.results[0][0].transcript;
                // Remove trailing punctuation which voice input sometimes adds
                const cleanTranscript = transcript.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, "");

                searchInput.value = cleanTranscript;
                filterAndSortProducts(); // Trigger filter

                showMessage(`Found items matching: "${cleanTranscript}"`, 'success');
                btn.classList.remove('listening');
                searchInput.placeholder = "e.g. Tomato, Mango...";
            };

            recognition.onerror = function (event) {
                console.error("Speech recognition error", event.error);
                btn.classList.remove('listening');
                searchInput.placeholder = "e.g. Tomato, Mango...";

                if (event.error === 'no-speech') {
                    showMessage("No speech detected. Please try again.", 'error');
                } else if (event.error === 'not-allowed') {
                    showMessage("Microphone access denied. Check your browser settings.", 'error');
                } else {
                    showMessage("Voice search failed. Please try typing.", 'error');
                }
            };

            recognition.onend = function () {
                btn.classList.remove('listening');
                // If user didn't speak, revert placeholder
                if (searchInput.value === '') {
                    searchInput.placeholder = "e.g. Tomato, Mango...";
                }
            };

            // Start recognition
            recognition.start();
        }

        // MODIFIED: Updated to show stock info and disable button
        window.createProductCardHTML = function (product) {
            const price = parseFloat(product.price);
            const imageFallback = product.image || `https://via.placeholder.com/400x250/e0ffec/37a552?text=${encodeURIComponent(product.name.replace(/\s/g, '+'))}`;
            const displayFarmerId = product.farmerId ? product.farmerId.substring(0, 8) + '...' : 'N/A';
            const displayLocation = product.farmerLocation || 'Unknown Location';

            const stock = product.stock !== undefined ? product.stock : 0;
            const isOutOfStock = stock <= 0;
            const stockClass = isOutOfStock ? 'stock-info out-of-stock' : 'stock-info';
            const stockText = isOutOfStock ? 'Out of Stock' : `In Stock: ${stock} ${product.unit}`;
            const btnDisabled = isOutOfStock ? 'disabled' : '';
            const btnText = isOutOfStock ? 'Out of Stock' : 'Add to Basket';

            return `
                <div class="product-card">
                    <img src="${product.image}" alt="${product.name}" 
                         onerror="this.onerror=null;this.src='${imageFallback}';"
                         loading="lazy">
                    <div class="card-content">
                        <div class="card-header">
                            <h3>${product.name}</h3>
                            <span class="freshness-tag">${product.freshness}</span>
                        </div>
                        <p class="price-tag">${price.toFixed(2)} <span class="unit">/${product.unit.replace('per ', '').trim()}</span></p>
                        <p class="${stockClass}">${stockText}</p>
                        <p class="seller-info">Seller: ${displayFarmerId}</p>
                        <p class="location-info">From: ${displayLocation}</p>
                        <button onclick="addToCart('${product.id}')" class="add-to-cart-btn" data-i18n="add_to_basket" ${btnDisabled}>
                            ${btnText}
                        </button>
                    </div>
                </div>
            `;
        }

        function renderProducts() {
            const productGrid = document.getElementById('productGrid');
            if (!productGrid) return;

            productGrid.innerHTML = '';

            if (products.length === 0 && rawProducts.length === 0) {
                productGrid.innerHTML = `<p style="text-align: center; color: var(--color-text-light); grid-column: 1 / -1; padding-top: 3rem;" id="noProductsMessage">
                                Loading products or no products found in the market...
                            </p>`;
            } else if (products.length === 0 && rawProducts.length > 0) {
                productGrid.innerHTML = `<p style="text-align: center; color: var(--color-text-light); grid-column: 1 / -1; padding-top: 3rem;" id="noProductsMessage">
                                No products match your current filters.
                            </p>`;
            } else {
                const html = products.map(createProductCardHTML).join('');
                productGrid.innerHTML = html;
            }
        }


        // MODIFIED: Check stock before adding
        window.addToCart = function (productId) {
            const productToAdd = rawProducts.find(p => p.id === productId);
            if (!productToAdd) return;

            // Check stock limit
            const currentStock = productToAdd.stock !== undefined ? productToAdd.stock : 0;
            const existingCartItemIndex = cart.findIndex(item => item.product.id === productId);
            const currentQtyInCart = existingCartItemIndex > -1 ? cart[existingCartItemIndex].quantity : 0;

            if (currentQtyInCart + 1 > currentStock) {
                showMessage(`Cannot add more. Only ${currentStock} available.`, 'error');
                return;
            }

            if (existingCartItemIndex > -1) {
                cart[existingCartItemIndex].quantity++;
            } else {
                cart.push({ product: productToAdd, quantity: 1 });
            }

            updateCartCount();
            showMessage(`${productToAdd.name} added to basket!`, 'success');
            if (document.getElementById('cartPage').style.display === 'block') {
                renderCartPage();
            }
        }

        // MODIFIED: Check stock limit on update
        window.updateCartQuantity = function (productId, change) {
            const cartItemIndex = cart.findIndex(item => item.product.id === productId);
            if (cartItemIndex === -1) return;

            const product = cart[cartItemIndex].product;
            const currentStock = product.stock !== undefined ? product.stock : 0;
            const newQuantity = cart[cartItemIndex].quantity + change;

            if (change > 0 && newQuantity > currentStock) {
                showMessage(`Cannot add more. Only ${currentStock} available.`, 'error');
                return;
            }

            if (newQuantity <= 0) {
                removeFromCart(cartItemIndex);
            } else {
                cart[cartItemIndex].quantity = newQuantity;
                renderCartPage();
            }
        }

        window.removeFromCart = function (index) {
            if (index < 0 || index >= cart.length) return;
            const name = cart[index].product.name;
            cart.splice(index, 1);
            showMessage(`${name} removed from basket.`, 'error');
            renderCartPage();
        }


        function setupProductListener() {
            if (!db) {
                // Mock data logic
                rawProducts = [
                    { id: 'p1', name: 'Organic Tomatoes', price: 50.00, stock: 50, unit: 'per kg', farmerId: 'mock1...', farmerLocation: 'Tirupati', image: 'https://via.placeholder.com/400x300/e0ffec/37a552?text=Tomatoes', freshness: 'Today', timestamp: new Date().toISOString() },
                    { id: 'p2', name: 'Fresh Spinach', price: 30.00, stock: 20, unit: 'per bundle', farmerId: 'mock2...', farmerLocation: 'Hyderabad', image: 'https://via.placeholder.com/400x300/e0ffec/37a552?text=Spinach', freshness: 'Yesterday', timestamp: new Date(Date.now() - 86400000).toISOString() },
                    { id: 'p3', name: 'Local Milk', price: 80.00, stock: 0, unit: 'per liter', farmerId: 'mock1...', farmerLocation: 'Tirupati', image: 'https://via.placeholder.com/400x300/e0ffec/37a552?text=Milk', freshness: 'Today', timestamp: new Date().toISOString() }
                ];
                document.getElementById('priceRange').min = 10; document.getElementById('priceRange').max = 250; document.getElementById('priceRange').value = 250;
                updatePriceValue(250);
                filterAndSortProducts();
                return;
            }

            const productsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');

            onSnapshot(productsCollectionRef, (snapshot) => {
                const fetchedProducts = [];
                let maxPrice = 0;

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const price = parseFloat(data.price);

                    if (price > maxPrice) { maxPrice = price; }

                    fetchedProducts.push({
                        id: doc.id,
                        name: data.name,
                        price: price,
                        unit: data.unit,
                        stock: data.stock !== undefined ? parseInt(data.stock) : 0, // NEW: Read Stock
                        farmerId: data.farmerId,
                        farmerLocation: data.farmerLocation,
                        image: data.image,
                        freshness: data.freshness,
                        timestamp: data.timestamp || new Date(0).toISOString()
                    });
                });

                rawProducts = fetchedProducts;

                maxPrice = Math.ceil(maxPrice / 10) * 10;
                const newMax = maxPrice > 0 ? maxPrice : 250;
                const priceRangeInput = document.getElementById('priceRange');
                const currentValue = parseFloat(priceRangeInput.value);

                priceRangeInput.max = newMax;
                if (currentValue === 250 || currentValue > newMax) {
                    priceRangeInput.value = newMax;
                }

                updatePriceValue(priceRangeInput.value);
                filterAndSortProducts();

            }, (error) => {
                console.error("Error listening to products:", error);
                const msg = document.getElementById('noProductsMessage');
                if (msg) msg.textContent = "Error loading products. (Check Permissions)";
            });
        }


        // --- FARMER LOGIC: CRUD & LISTINGS ---

        window.optimizeListing = async function (productId) {
            if (apiKey === "" && !isHostedEnvironment) {
                renderMessage("The AI Assistant is not configured. Please add your Gemini API Key.", "gemini");
                return;
            }

            const listing = farmerListings.find(p => p.id === productId);
            if (!listing) return;

            showLLMModal('Optimizing Listing...', true);
            document.getElementById('llmOutput').innerHTML = document.getElementById('llmLoading').outerHTML;

            const userQuery = `You are a market expert. Provide concrete suggestions to improve this product listing for better customer appeal and sales: Product Name: ${listing.name}, Price: ${listing.price} / ${listing.unit}, Freshness: ${listing.freshness}, Location: ${listing.farmerLocation}. Focus on the name, description clarity, and unit usage. Respond in a brief list format.`;

            const systemPrompt = `You are the KisanConnect Farm Business AI. Your goal is to help the farmer maximize their sales, improve product quality, and manage their listings. Your tone is helpful, professional, and advisory. Context: The user is a farmer using the KisanConnect app.`;

            const payload = {
                contents: [{ role: "user", parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            try {
                const response = await retryFetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const generatedText = response.candidates?.[0]?.content?.parts?.[0]?.text || "No suggestions found.";

                document.getElementById('llmOutput').innerHTML = `
                    <h4 style="font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--color-text-dark);">Suggestions for "${listing.name}":</h4>
                    <div style="padding-left: 1rem; border-left: 3px solid #8b5cf6; color: var(--color-text-dark);">
                        ${markdownToHtml(generatedText)}
                    </div>
                `;
            } catch (error) {
                document.getElementById('llmOutput').innerHTML = `<p style="color: var(--color-danger);">Error: Could not connect to AI service. Check your Gemini API key and network connection.</p>`;
                console.error("Gemini API Optimization Error:", error);
            }
        }

        window.showEditProductModal = function (productId) {
            const product = farmerListings.find(p => p.id === productId);
            if (!product) return;

            document.getElementById('editProductId').value = product.id;
            document.getElementById('editProductName').value = product.name;
            document.getElementById('editProductPrice').value = product.price.toFixed(2);
            document.getElementById('editProductStock').value = product.stock; // NEW: Populate Stock
            document.getElementById('editProductUnit').value = product.unit;
            document.getElementById('editProductFreshness').value = product.freshness;
            document.getElementById('editProductLocation').value = product.farmerLocation || '';
            document.getElementById('editProductImage').value = '';

            const modal = document.getElementById('editProductModal');
            modal.style.display = 'flex';
            setTimeout(() => {
                document.getElementById('editProductModalContent').style.transform = 'scale(1)';
                document.getElementById('editProductModalContent').style.opacity = '1';
            }, 50);
        }

        window.closeEditProductModal = function () {
            const content = document.getElementById('editProductModalContent');
            content.style.transform = 'scale(0.95)';
            content.style.opacity = '0';
            setTimeout(() => { document.getElementById('editProductModal').style.display = 'none'; }, 300);
        }

        // MODIFIED: Handle stock update
        window.handleUpdateProduct = async function () {
            if (!db) { showMessage("Cannot update product. Database connection failed.", 'error'); return; }
            if (currentUserRole !== 'farmer') {
                showMessage("Access Denied. Only farmers can update products.", 'error');
                return;
            }

            const btn = document.getElementById('editProductSubmitBtn');
            btn.disabled = true;
            btn.textContent = 'Saving Changes...';

            const productId = document.getElementById('editProductId').value;
            const originalProduct = farmerListings.find(p => p.id === productId);
            const newImageUrl = document.getElementById('editProductImage').value.trim();

            const updatedData = {
                name: document.getElementById('editProductName').value,
                price: parseFloat(document.getElementById('editProductPrice').value).toFixed(2),
                stock: parseInt(document.getElementById('editProductStock').value), // NEW: Capture Stock
                unit: document.getElementById('editProductUnit').value,
                freshness: document.getElementById('editProductFreshness').value,
                farmerLocation: document.getElementById('editProductLocation').value.trim(),
                image: newImageUrl || originalProduct.image,
                timestamp: new Date().toISOString()
            };

            if (!updatedData.name || isNaN(updatedData.price) || isNaN(updatedData.stock) || !updatedData.unit || !updatedData.freshness || !updatedData.farmerLocation) {
                showMessage("Please fill out all required fields, including stock.", 'error');
                btn.disabled = false;
                btn.textContent = 'Update Product';
                return;
            }

            try {
                const productDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', productId);
                await updateDoc(productDocRef, updatedData);
                closeEditProductModal();
                showMessage(`Product "${updatedData.name}" updated successfully!`, 'success');
            } catch (e) {
                console.error("Error updating product:", e);
                showMessage("Failed to update product. Check console/Firestore Rules.", 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Update Product';
            }
        }


        function setupFarmerListingsListener() {
            if (!db) {
                const msg = document.getElementById('noFarmerListings');
                if (msg) msg.innerHTML = "Cannot load listings: Running in local mock mode.";
                farmerListings = [
                    { id: 'p-mock-1', name: 'Mock Item 1', price: 10.00, stock: 10, unit: 'per kg', freshness: 'Mock Today', farmerLocation: 'Tirupati', farmerId: currentUserId },
                    { id: 'p-mock-2', name: 'Mock Item 2', price: 25.00, stock: 5, unit: 'per bundle', freshness: 'Mock Yesterday', farmerLocation: 'Hyderabad', farmerId: currentUserId }
                ];
                renderFarmerListings();
                return;
            }

            const productsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');
            const farmerQuery = query(productsCollectionRef, where('farmerId', '==', currentUserId));

            onSnapshot(farmerQuery, (snapshot) => {
                const fetchedListings = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    fetchedListings.push({
                        id: doc.id,
                        name: data.name,
                        price: parseFloat(data.price),
                        stock: parseInt(data.stock) || 0, // NEW
                        unit: data.unit,
                        freshness: data.freshness,
                        farmerLocation: data.farmerLocation,
                        image: data.image,
                        farmerId: data.farmerId
                    });
                });

                farmerListings = fetchedListings;
                renderFarmerListings();
            },
                (error) => {
                    console.error("Error listening to farmer listings:", error);
                    const msg = document.getElementById('noFarmerListings');
                    if (msg) msg.innerHTML = "Error loading your listings. (Check Permissions)";
                });
        }

        // MODIFIED: Show stock in listing card
        function renderFarmerListings() {
            const container = document.getElementById('myListingsContainer');
            if (!container) return;
            if (farmerListings.length === 0) {
                container.innerHTML = `<p id="noFarmerListings" style="grid-column: 1 / -1; text-align: center; color: var(--color-text-light);">No products currently listed by you.</p>`;
            } else {
                farmerListings.sort((a, b) => a.name.localeCompare(b.name));
                const html = farmerListings.map(p => `
                    <div class="listing-card">
                        <div class="listing-details">
                            <h4>${p.name}</h4>
                            <p>Price: ${p.price.toFixed(2)} / ${p.unit}</p>
                            <p style="font-weight: 600; color: var(--color-primary-dark);">Stock: ${p.stock}</p>
                            <p>Freshness: ${p.freshness}</p>
                            <p>Location: ${p.farmerLocation || 'N/A'}</p>
                        </div>
                        <div class="listing-buttons">
                            <button onclick="showEditProductModal('${p.id}')" class="edit-btn">Edit</button> 
                            <button onclick="deleteProduct('${p.id}', '${p.name}')" class="delete-btn">Delete</button>
                        </div>
                        <button onclick="optimizeListing('${p.id}')" class="optimize-btn"> Optimize Listing</button>
                    </div>
                `).join('');

                container.innerHTML = html;
            }
        }

        // MODIFIED: Capture stock when adding
        window.addProduct = async function () {
            const nameInput = document.getElementById('productName');
            const priceInput = document.getElementById('productPrice');
            const stockInput = document.getElementById('productStock'); // NEW
            const unitInput = document.getElementById('productUnit');
            const freshnessInput = document.getElementById('productFreshness');
            const locationInput = document.getElementById('productLocation');
            const imageInput = document.getElementById('productImage');
            const btn = document.getElementById('addProductSubmitBtn');

            if (!nameInput || !priceInput || !stockInput || !unitInput || !freshnessInput || !imageInput || !locationInput) {
                showMessage("Error: Form elements not found.", 'error');
                return;
            }

            const name = nameInput.value.trim();
            const price = parseFloat(priceInput.value).toFixed(2);
            const stock = parseInt(stockInput.value); // NEW
            const unit = unitInput.value;
            const freshness = freshnessInput.value.trim();
            const location = locationInput.value.trim();
            const image = imageInput.value.trim() || `https://via.placeholder.com/400x300/e0ffec/37a552?text=${encodeURIComponent(name.replace(/\s/g, '+'))}`;

            if (!name || isNaN(price) || isNaN(stock) || !unit || !freshness || !location) {
                showMessage("Please fill out all required product details, including stock.", 'error');
                return;
            }

            if (!db) {
                showMessage(`Product "${name}" added to mock list, but NOT SAVED to database.`, 'error');
                if (document.getElementById('addProductForm')) document.getElementById('addProductForm').reset();
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Adding Product...';

            const newProduct = {
                name: name,
                price: price,
                stock: stock, // NEW
                unit: unit,
                freshness: freshness,
                farmerLocation: location,
                image: image,
                farmerId: currentUserId,
                timestamp: new Date().toISOString()
            };

            try {
                const productsCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');
                await addDoc(productsCollectionRef, newProduct);
                setTimeout(() => {
                    showMessage(`Product "${name}" successfully added!`, 'success');
                }, 50);
                if (document.getElementById('addProductForm')) document.getElementById('addProductForm').reset();
            } catch (e) {
                console.error("Error adding product:", e);
                showMessage("Failed to add product. Check console for details.", 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Add Product to Market';
            }
        }

        window.deleteProduct = async function (productId, productName) {
            if (currentUserRole !== 'farmer') {
                showMessage("Access Denied. Only farmers can delete listings.", 'error');
                return;
            }
            if (!db) {
                showMessage(`Cannot delete "${productName}". Database connection failed.`, 'error');
                return;
            }

            console.log(`Attempting to delete product: ${productId}`);

            try {
                console.warn("Attempting insecure delete. Firestore Rules MUST be implemented for security.");
                const productDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', productId);
                await deleteDoc(productDocRef);
                showMessage(`Listing "${productName}" successfully deleted.`, 'success');
            } catch (e) {
                console.error("Failed to delete document:", e);
                showMessage(`Error deleting listing. Check console/Firestore Rules.`, 'error');
            }
        }

        // --- NEW: Farmer Order Management (Refactored) ---
        function setupFarmerOrdersListener() {
            if (!db) {
                const msg = document.getElementById('noFarmerOrdersMessage');
                if (msg) msg.textContent = "Cannot load orders: Running in local mock mode.";
                return;
            }

            const ordersCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');

            const farmerQuery = query(
                ordersCollectionRef,
                where('farmerIdsInOrder', 'array-contains', currentUserId)
            );

            onSnapshot(farmerQuery, (snapshot) => {
                if (!isFirstFarmerLoad) {
                    snapshot.docChanges().forEach((change) => {
                        if (change.type === "added") {
                            const orderData = change.doc.data();
                            if (orderData.status === 'Processing') {
                                const orderIdShort = change.doc.id.substring(0, 6);
                                showNotification(` New Order Received! (ID: ${orderIdShort})`, 'new-order');
                                playNotificationSound();
                            }
                        }
                    });
                }
                isFirstFarmerLoad = false;

                const fetchedOrders = [];
                snapshot.forEach(doc => {
                    fetchedOrders.push({ id: doc.id, ...doc.data() });
                });
                fetchedOrders.sort((a, b) => new Date(b.orderDate).getTime() - new Date(a.orderDate).getTime());

                farmerAnalyticsData = fetchedOrders;

                if (document.getElementById('farmerGrowthPage').style.display === 'block') {
                    renderGrowthChart();
                }

                renderFarmerOrders(fetchedOrders);
            }, (error) => {
                console.error("Error fetching farmer orders:", error);
                const msg = document.getElementById('noFarmerOrdersMessage');
                if (msg) msg.innerHTML = `<p style="text-align: center; color: var(--color-danger); padding: 3rem;">
                    Error loading orders. (Have you created the Firestore Index? Check the console.)
                </p>`;
            });
        }

        function renderFarmerOrders(allOrders) {
            const container = document.getElementById('farmerOrdersList');
            const noMsg = document.getElementById('noFarmerOrdersMessage');
            if (!container) return;

            const visibleOrders = allOrders.filter(order => order.status !== 'Rejected');

            let totalEarnings = 0;
            let totalOrdersCount = 0;
            let pendingCount = 0;

            visibleOrders.forEach(order => {
                if (order.status === 'Accepted') {
                    totalOrdersCount++;
                    const farmerItems = order.items.filter(item => item.farmerId === currentUserId);
                    farmerItems.forEach(item => {
                        totalEarnings += (parseFloat(item.price) * item.quantity);
                    });
                }
                else if (order.status === 'Processing') {
                    pendingCount++;
                }
            });

            document.getElementById('metricEarnings').textContent = totalEarnings.toFixed(2);
            document.getElementById('metricOrders').textContent = totalOrdersCount;
            document.getElementById('metricPending').textContent = pendingCount;


            if (visibleOrders.length === 0) {
                if (noMsg) {
                    noMsg.style.display = 'block';
                    noMsg.textContent = "No active orders found.";
                }
                container.innerHTML = '';
                return;
            }

            if (noMsg) noMsg.style.display = 'none';

            const html = visibleOrders.map(order => {
                const farmerItems = order.items.filter(item => item.farmerId === currentUserId);

                const itemListHtml = farmerItems.map(item => `
                    <div class="farmer-order-item-details">
                        <p><strong>Item:</strong> ${item.name} (x${item.quantity} ${item.unit})</p>
                        <p><strong>Value:</strong> ${(item.price * item.quantity).toFixed(2)}</p>
                    </div>
                `).join('');

                let actionArea = '';

                if (order.status === 'Processing') {
                    actionArea = `
                        <div class="farmer-order-actions">
                            <button onclick="updateOrderStatus('${order.id}', 'Rejected')" class="reject-btn">Reject</button>
                            <button onclick="updateOrderStatus('${order.id}', 'Accepted')" class="accept-btn">Accept Order</button>
                        </div>
                    `;
                } else if (order.status === 'Accepted') {
                    actionArea = `
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--color-border); text-align: center;">
                            <span style="background-color: #d1fae5; color: #065f46; padding: 0.5rem 1rem; border-radius: 9999px; font-weight: 700; font-size: 0.875rem;">
                                 Order Accepted
                            </span>
                        </div>
                    `;
                } else if (order.status === 'Cancelled') {
                    actionArea = `
                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--color-border); text-align: center;">
                            <span style="background-color: #fee2e2; color: #991b1b; padding: 0.5rem 1rem; border-radius: 9999px; font-weight: 700; font-size: 0.875rem;">
                                 Cancelled by Customer
                            </span>
                        </div>
                    `;
                }

                return `
                    <div class="farmer-order-item-card">
                        <div class="farmer-order-item-header">
                            <h4>Order ID: ${order.id.substring(0, 8)}...</h4>
                            <span class="order-status ${order.status.toLowerCase()}">${order.status}</span>
                        </div>
                        <p style="font-size: 0.9rem; color: var(--color-text-light);">Customer ID: ${order.userId.substring(0, 8)}...</p>
                        ${itemListHtml}
                        ${actionArea}
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        window.updateOrderStatus = async function (orderId, newStatus) {
            if (!db) return;

            try {
                const orderDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId);

                await updateDoc(orderDocRef, {
                    status: newStatus
                });

                const msgType = newStatus === 'Accepted' ? 'success' : 'error';
                showMessage(`Order marked as ${newStatus}`, msgType);

            } catch (e) {
                console.error("Error updating order status:", e);
                showMessage("Failed to update status. Check permissions.", 'error');
            }
        }

        // NEW: Growth Chart Logic
        let growthChartInstance = null;

        function renderGrowthChart() {
            const ctx = document.getElementById('growthChart').getContext('2d');

            const dailySales = {};

            for (let i = 13; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                dailySales[dateStr] = 0;
            }

            farmerAnalyticsData.forEach(order => {
                if (order.status === 'Accepted') {
                    const dateStr = order.orderDate.split('T')[0];

                    const farmerItems = order.items.filter(item => item.farmerId === currentUserId);
                    let orderTotal = 0;
                    farmerItems.forEach(item => {
                        orderTotal += (parseFloat(item.price) * item.quantity);
                    });

                    if (dailySales[dateStr] !== undefined) {
                        dailySales[dateStr] += orderTotal;
                    }
                }
            });

            const dates = Object.keys(dailySales).sort();
            const values = dates.map(date => dailySales[date]);

            const currentWeekValues = values.slice(7);
            const prevWeekValues = values.slice(0, 7);

            const currentTotal = currentWeekValues.reduce((a, b) => a + b, 0);
            const prevTotal = prevWeekValues.reduce((a, b) => a + b, 0);

            let percentage = 0;
            if (prevTotal > 0) {
                percentage = ((currentTotal - prevTotal) / prevTotal) * 100;
            } else if (currentTotal > 0) {
                percentage = 100;
            }

            const rateEl = document.getElementById('growthRateDisplay');
            const compareEl = document.getElementById('growthComparisonText');

            if (percentage >= 0) {
                rateEl.textContent = `+${percentage.toFixed(1)}%`;
                rateEl.className = 'growth-rate';
                compareEl.textContent = `Revenue increased compared to previous 7 days`;
            } else {
                rateEl.textContent = `${percentage.toFixed(1)}%`;
                rateEl.className = 'growth-rate negative';
                compareEl.textContent = `Revenue decreased compared to previous 7 days`;
            }

            if (growthChartInstance) {
                growthChartInstance.destroy();
            }

            growthChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates.slice(7),
                    datasets: [{
                        label: 'Daily Revenue ()',
                        data: currentWeekValues,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0,0,0,0.05)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }


        // --- CART/ORDER LOGIC (Refactored) ---
        function calculateCartTotals() {
            const subtotal = cart.reduce((sum, item) => sum + (parseFloat(item.product.price) * item.quantity), 0);
            const taxRate = 0.05;
            const tax = subtotal * taxRate;
            const grandTotal = subtotal + tax;
            return { subtotal, tax, grandTotal };
        }

        function renderCartPage() {
            const list = document.getElementById('cartItemsList');
            if (!list) return;
            updateCartCount();
            const totals = calculateCartTotals();
            const btn = document.getElementById('checkoutBtn');

            if (cart.length === 0) {
                list.innerHTML = `<p class="empty-cart-message">Your basket is currently empty.</p>`;
                if (btn) { btn.disabled = true; btn.style.opacity = 0.6; }
            } else {
                if (btn) { btn.disabled = false; btn.style.opacity = 1; }

                const html = cart.map((item, index) => {
                    const product = item.product;
                    const itemTotalPrice = (parseFloat(product.price) * item.quantity).toFixed(2);
                    return `
                        <div class="cart-item">
                            <div class="item-details">
                                <img src="${product.image}" alt="${product.name}" 
                                     onerror="this.onerror=null;this.src='https://via.placeholder.com/60x60/e0ffec/37a552?text=Item';">
                            </div>
                            <p class="item-name-unit">${product.name}<br><small>(${product.unit})</small></p>
                            <p class="item-price">${itemTotalPrice}</p>
                            <div class="quantity-controls">
                                <button onclick="updateCartQuantity('${product.id}', -1)" class="quantity-btn">-</button>
                                <span class="quantity-display">${item.quantity}</span>
                                <button onclick="updateCartQuantity('${product.id}', 1)" class="quantity-btn">+</button>
                            </div>
                            <button onclick="removeFromCart(${index})" class="remove-btn" title="Remove Item">&times;</button>
                        </div>
                    `;
                }).join('');

                list.innerHTML = html;
            }
            document.getElementById('cartSubtotal').textContent = `${totals.subtotal.toFixed(2)}`;
            document.getElementById('cartTax').textContent = `${totals.tax.toFixed(2)}`;
            document.getElementById('cartGrandTotal').textContent = `${totals.grandTotal.toFixed(2)}`;
        }

        // Razorpay Configuration - REPLACE WITH YOUR TEST KEY
        const RAZORPAY_KEY_ID = 'rzp_test_RokMOj4Z6hbg14'; // Get from razorpay.com dashboard

        // NEW: Process Payment based on selected method
        window.processPayment = async function () {
            if (cart.length === 0) {
                showMessage('Your cart is empty!', 'error');
                return;
            }

            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            const totals = calculateCartTotals();

            if (paymentMethod === 'cod') {
                // Cash on Delivery - use existing checkout
                await checkout('cod');
            } else {
                // Online payment via Razorpay
                initiateRazorpayPayment(totals, paymentMethod);
            }
        }

        // NEW: Razorpay Payment Integration
        function initiateRazorpayPayment(totals, preferredMethod) {
            const amountInPaise = Math.round(totals.grandTotal * 100);

            const options = {
                key: RAZORPAY_KEY_ID,
                amount: amountInPaise,
                currency: 'INR',
                name: 'KisanConnect',
                description: 'Order Payment',
                image: 'https://via.placeholder.com/128x128/10b981/ffffff?text=KC',
                prefill: {
                    name: currentUserId || 'Customer',
                    email: '',
                    contact: ''
                },
                theme: {
                    color: '#10b981'
                },
                handler: async function (response) {
                    // Payment successful
                    console.log('Payment Success:', response);
                    showMessage('Payment successful! Processing order...', 'success');

                    // Create order with payment details
                    await checkout('online', response.razorpay_payment_id);
                },
                modal: {
                    ondismiss: function () {
                        showMessage('Payment cancelled. Your cart is still saved.', 'error');
                    }
                },
                notes: {
                    order_type: 'KisanConnect Purchase'
                }
            };

            // Set preferred payment method
            if (preferredMethod === 'upi') {
                options.method = { upi: true, card: true, netbanking: true, wallet: true };
            } else if (preferredMethod === 'card') {
                options.method = { card: true, upi: true, netbanking: true, wallet: true };
            } else if (preferredMethod === 'netbanking') {
                options.method = { netbanking: true, card: true, upi: true, wallet: true };
            }

            try {
                const rzp = new Razorpay(options);
                rzp.on('payment.failed', function (response) {
                    console.error('Payment Failed:', response.error);
                    showMessage(`Payment failed: ${response.error.description}`, 'error');
                });
                rzp.open();
            } catch (error) {
                console.error('Razorpay Error:', error);
                showMessage('Payment gateway error. Please try again or use Cash on Delivery.', 'error');
            }
        }

        // MODIFIED: Decrement stock logic - now accepts payment info
        window.checkout = async function (paymentMode = 'cod', paymentId = null) {
            if (cart.length === 0) { return; }
            const totals = calculateCartTotals();

            const farmerIds = [...new Set(cart.map(item => item.product.farmerId))];

            const orderDetails = {
                userId: currentUserId,
                items: cart.map(item => ({
                    id: item.product.id,
                    name: item.product.name,
                    price: item.product.price,
                    unit: item.product.unit,
                    quantity: item.quantity,
                    farmerId: item.product.farmerId,
                    image: item.product.image
                })),
                farmerIdsInOrder: farmerIds,
                subtotal: totals.subtotal.toFixed(2),
                tax: totals.tax.toFixed(2),
                grandTotal: totals.grandTotal.toFixed(2),
                status: 'Processing',
                paymentMode: paymentMode,
                paymentId: paymentId,
                paymentStatus: paymentMode === 'online' ? 'Paid' : 'Pending',
                orderDate: new Date().toISOString(),
                deliveryDate: new Date(Date.now() + 3 * 24 * 60 * 60 * 1000).toISOString()
            };

            if (db) {
                try {
                    const ordersCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
                    await addDoc(ordersCollectionRef, orderDetails);

                    // FIXED: Atomic stock decrement using increment()
                    for (const item of cart) {
                        const productRef = doc(db, 'artifacts', appId, 'public', 'data', 'products', item.product.id);

                        // Use atomic increment to prevent race conditions
                        try {
                            await updateDoc(productRef, {
                                stock: increment(-item.quantity)
                            });
                        } catch (stockError) {
                            console.warn(`Could not update stock for ${item.product.name}:`, stockError);
                        }
                    }

                    showMessage('Order placed successfully! Check your order history.', 'success');
                } catch (e) {
                    console.error("Error saving order:", e);
                    showMessage('Failed to place order. Please try again.', 'error');
                }
            } else {
                showMessage('Order Placed (Mock Mode - Not Saved)', 'success');
            }

            cart = [];
            updateCartCount();
            toggleCustomerView('market');
        }

        function updateCartCount() {
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            const el = document.getElementById('cartCounter');
            if (el) el.textContent = totalItems;
        }

        // --- ORDER HISTORY LOGIC (Refactored) ---
        function setupOrderListener() {
            if (!db) {
                const msg = document.getElementById('noOrdersMessage');
                if (msg) msg.innerHTML = "Cannot load order history: Running in local mock mode.";
                return;
            }

            const ordersCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
            const customerQuery = query(ordersCollectionRef, where('userId', '==', currentUserId));

            onSnapshot(customerQuery, (snapshot) => {
                const fetchedOrders = [];
                snapshot.forEach(doc => {
                    fetchedOrders.push({ id: doc.id, ...doc.data() });
                });
                orders = fetchedOrders.sort((a, b) => new Date(b.orderDate).getTime() - new Date(a.orderDate).getTime());
                renderOrders();
            },
                (error) => {
                    console.error("Error listening to orders:", error);
                    const msg = document.getElementById('noOrdersMessage');
                    if (msg) msg.innerHTML = "Error loading order history. (Check Permissions)";
                });
        }

        function renderOrders() {
            const list = document.getElementById('ordersList');
            if (!list) return;
            if (orders.length === 0) {
                list.innerHTML = `<p id="noOrdersMessage" style="text-align: center; color: var(--color-text-light); padding: 3rem;">
                            You haven't placed any orders yet. Start shopping!
                        </p>`;
            } else {
                const html = orders.map(order => {
                    const orderDate = new Date(order.orderDate).toLocaleDateString();
                    const deliveryDate = new Date(order.deliveryDate).toLocaleDateString();

                    let statusClass = 'processing';
                    if (order.status === 'Delivered') statusClass = 'delivered';
                    if (order.status === 'Cancelled') statusClass = 'cancelled';

                    const deliveryInfo = order.status === 'Delivered'
                        ? `<span class="order-delivery">Delivered on: ${deliveryDate}</span>`
                        : (order.status === 'Cancelled' ? `<span class="order-delivery">Order Cancelled</span>` : `<span class="order-delivery">Est. Delivery: ${deliveryDate}</span>`);

                    const itemList = order.items.map(item => `<p>${item.name} (Qty: ${item.quantity} x ${item.price} / ${item.unit})</p>`).join('');

                    const cancelButton = order.status === 'Processing'
                        ? `<div class="order-card-footer">
                               <button onclick="cancelOrder('${order.id}')" class="cancel-order-btn">Cancel Order</button>
                           </div>`
                        : '';

                    return `
                     <div class="order-card">
                        <div class="order-header-card">
                            <span class="order-id">Order ID: ${order.id.substring(0, 8)}...</span>
                            <span class="order-status ${statusClass}">${order.status}</span> 
                        </div>
                        <div class="order-details-summary">
                            <span class="order-total">Total: ${order.grandTotal}</span>
                            ${deliveryInfo}
                        </div>
                        <p style="font-size: 0.8rem; color: var(--color-text-light); margin-top: 0.5rem;">Ordered on: ${orderDate}</p>
                        <div class="order-item-list">
                            <p style="font-weight: 700; color: var(--color-text-dark);">Items Purchased:</p>
                            ${itemList}
                        </div>
                        ${cancelButton} 
                    </div>
                    `;
                }).join('');
                list.innerHTML = html;
            }
        }

        window.cancelOrder = async function (orderId) {
            if (!db) { showMessage("Cannot cancel order. Database connection failed.", 'error'); return; }
            if (!currentUserId) { showMessage("User not logged in.", 'error'); return; }

            console.log(`Attempting to cancel order: ${orderId}`);
            try {
                const orderDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'orders', orderId);

                const orderDoc = await getDoc(orderDocRef);
                if (!orderDoc.exists()) {
                    throw new Error("Order not found.");
                }
                const orderData = orderDoc.data();
                if (orderData.userId !== currentUserId) {
                    throw new Error("You do not have permission to cancel this order.");
                }
                if (orderData.status !== 'Processing') {
                    throw new Error("Order can no longer be cancelled.");
                }

                await updateDoc(orderDocRef, {
                    status: 'Cancelled'
                });
                showMessage(`Order ${orderId.substring(0, 8)}... has been cancelled.`, 'success');
            } catch (e) {
                console.error("Error cancelling order:", e);
                showMessage(`Failed to cancel the order. ${e.message}`, 'error');
            }
        }

        // --- NEW: Profile Data Functions ---
        window.loadUserProfile = async function () {
            if (!db || !currentUserId) return;

            try {
                const userDocRef = doc(db, 'artifacts', appId, 'users', currentUserId);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    const data = userDoc.data().profile || {};

                    document.getElementById('profileName').value = data.name || '';
                    document.getElementById('profilePhone').value = data.phone || '';

                    if (currentUserRole === 'farmer') {
                        document.getElementById('profileFarmName').value = data.farmName || '';
                        document.getElementById('profileFarmLocation').value = data.farmLocation || '';
                        document.getElementById('profileUPI').value = data.upiId || '';
                    } else {
                        document.getElementById('profileAddress').value = data.address || '';
                        document.getElementById('profileCity').value = data.city || '';
                    }
                }
                updateProfileProgress();

            } catch (e) {
                console.error("Error loading profile:", e);
            }
        }

        window.updateAddProductProgress = function () {
            const inputs = [
                document.getElementById('productName'),
                document.getElementById('productPrice'),
                document.getElementById('productStock'), // Updated progress check
                document.getElementById('productUnit'),
                document.getElementById('productFreshness'),
                document.getElementById('productLocation')
            ];

            const filledCount = inputs.filter(input => input.value.trim() !== '').length;
            const totalFields = inputs.length;
            const percentage = Math.round((filledCount / totalFields) * 100);

            document.getElementById('addProductProgressBar').style.width = `${percentage}%`;
            document.getElementById('addProductProgressText').textContent = `${percentage}%`;

            const bar = document.getElementById('addProductProgressBar');
            if (percentage === 100) {
                bar.style.backgroundColor = 'var(--color-primary-dark)';
            } else {
                bar.style.backgroundColor = 'var(--color-primary)';
            }
        }

        window.updateProfileProgress = function () {
            let inputs = [
                document.getElementById('profileName'),
                document.getElementById('profilePhone')
            ];

            if (currentUserRole === 'farmer') {
                inputs.push(
                    document.getElementById('profileFarmName'),
                    document.getElementById('profileFarmLocation'),
                    document.getElementById('profileUPI')
                );
            } else {
                inputs.push(
                    document.getElementById('profileAddress'),
                    document.getElementById('profileCity')
                );
            }

            const filledCount = inputs.filter(input => input && input.value.trim() !== '').length;
            const totalFields = inputs.length;
            const percentage = totalFields === 0 ? 0 : Math.round((filledCount / totalFields) * 100);

            document.getElementById('profileProgressBar').style.width = `${percentage}%`;
            document.getElementById('profileProgressText').textContent = `${percentage}%`;
        }


        window.saveUserProfile = async function () {
            if (!db || !currentUserId) {
                showMessage("Cannot save profile. Please check connection.", 'error');
                return;
            }

            const profileData = {
                name: document.getElementById('profileName').value.trim(),
                phone: document.getElementById('profilePhone').value.trim()
            };

            if (currentUserRole === 'farmer') {
                profileData.farmName = document.getElementById('profileFarmName').value.trim();
                profileData.farmLocation = document.getElementById('profileFarmLocation').value.trim();
                profileData.upiId = document.getElementById('profileUPI').value.trim();
            } else {
                profileData.address = document.getElementById('profileAddress').value.trim();
                profileData.city = document.getElementById('profileCity').value.trim();
            }

            try {
                const userDocRef = doc(db, 'artifacts', appId, 'users', currentUserId);

                await setDoc(userDocRef, { profile: profileData }, { merge: true });

                showMessage("Profile saved successfully!", 'success');

                if (currentUserRole === 'farmer' && profileData.farmLocation) {
                    const addProdLoc = document.getElementById('productLocation');
                    if (addProdLoc && !addProdLoc.value) {
                        addProdLoc.value = profileData.farmLocation;
                    }
                }

            } catch (e) {
                console.error("Error saving profile:", e);
                showMessage("Failed to save profile.", 'error');
            }
        }


        // --- Utility for API calls with Exponential Backoff (Gemini) ---
        async function retryFetch(url, options = {}, retries = 0) {
            const maxRetries = MAX_RETRIES;
            const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
            try {
                if (apiKey === "" && isHostedEnvironment) {
                    // console.log("[API] Using environment-provided API key.");
                } else if (apiKey === "" && !isHostedEnvironment) {
                    throw new Error("Gemini API key is not set.");
                }

                const response = await fetch(url, options);
                if (!response.ok) {
                    if (response.status === 429 && retries < maxRetries) {
                        console.warn(`[API] Rate limited. Retrying in ${delay}ms... (Attempt ${retries + 1})`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return retryFetch(url, options, retries + 1);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                if (retries < maxRetries) {
                    console.warn(`[API] Fetch error. Retrying in ${delay}ms... (Attempt ${retries + 1})`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return retryFetch(url, options, retries + 1);
                }
                console.error(`[API] Fetch failed after ${maxRetries} attempts:`, error);
                throw error;
            }
        }

        // --- LLM Modal Functions (Generic for all LLM outputs) ---
        window.showLLMModal = function (title, isLoading = true) {
            document.getElementById('llmModalTitle').innerHTML = `<span style="margin-right: 0.5rem;"></span> ${title}`;
            document.getElementById('llmOutput').innerHTML = '';

            if (isLoading) {
                document.getElementById('llmLoading').style.display = 'flex';
            } else {
                document.getElementById('llmLoading').style.display = 'none';
            }

            const modal = document.getElementById('llmModal');
            modal.style.display = 'flex';
            setTimeout(() => {
                document.getElementById('llmContent').style.transform = 'scale(1)';
                document.getElementById('llmContent').style.opacity = '1';
            }, 50);
        }

        window.closeLLMModal = function () {
            const content = document.getElementById('llmContent');
            content.style.transform = 'scale(0.95)';
            content.style.opacity = '0';
            setTimeout(() => { document.getElementById('llmModal').style.display = 'none'; }, 300);
        }

        function markdownToHtml(markdownText) {
            return String(markdownText || '')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/^(?:\*|\-) (.*?)(?:\n|$)/gm, '<li>$1</li>')
                .replace(/(\<li\>.*?\<\/li\>)/gs, '<ul>$1</ul>')
                .replace(/\n/g, '<br>');
        }

        // --- CHAT BOT LOGIC ---
        let isChatOpen = false;
        window.toggleChat = function () {
            isChatOpen = !isChatOpen;
            document.getElementById('chatWindow').classList.toggle('open', isChatOpen);
        }

        function renderMessage(text, sender) {
            const messageEl = document.createElement('div');
            messageEl.classList.add('chat-message', `${sender}-message`);
            messageEl.innerHTML = `<p>${markdownToHtmlChat(text)}</p>`;
            const container = document.getElementById('chatMessages');
            container.appendChild(messageEl);
            container.scrollTop = container.scrollHeight;
        }

        function renderLoadingMessage() {
            const loadingEl = document.createElement('div');
            loadingEl.classList.add('chat-message', 'gemini-message');
            loadingEl.id = 'chatLoading';
            loadingEl.innerHTML = `<p style="display: flex; align-items: center;"><span class="chat-spinner"></span> Thinking...</p>`;
            const container = document.getElementById('chatMessages');
            container.appendChild(loadingEl);
            container.scrollTop = container.scrollHeight;
        }

        function removeLoadingMessage() {
            const loadingEl = document.getElementById('chatLoading');
            if (loadingEl) {
                loadingEl.remove();
            }
        }

        function markdownToHtmlChat(text) {
            let safeText = String(text || '');
            return safeText
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/^(?:\*|\-) (.*?)(?:\n|$)/gm, '<li>$1</li>')
                .replace(/(\<li\>.*?\<\/li\>)/gs, '<ul style="padding-left: 1.2rem; margin-top: 0.5rem;">$1</ul>')
                .replace(/\n/g, '<br>');
        }

        window.sendMessage = async function () {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            if (apiKey === "" && !isHostedEnvironment) {
                renderMessage("The AI chatbot is not configured. (Missing API Key).", "gemini");
                return;
            }

            renderMessage(message, 'user');
            input.value = '';
            renderLoadingMessage();

            chatHistory.push({ role: "user", parts: [{ text: message }] });

            const systemPrompt = currentUserRole === 'farmer'
                ? `You are the KisanConnect Farm Business AI. Your goal is to help the farmer maximize their sales, improve product quality, and manage their listings. Your tone is helpful, professional, and advisory. Context: The user is a farmer using the KisanConnect app. Keep responses concise.`
                : `You are the KisanConnect Customer AI. Your goal is to help the customer find the best produce, get recipe ideas, and understand product freshness. Your tone is friendly, enthusiastic, and helpful. Context: The user is a customer using the KisanConnect app. Keep responses concise.`;

            const payload = {
                contents: chatHistory,
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            try {
                const response = await retryFetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                removeLoadingMessage();
                const generatedText = response.candidates?.[0]?.content?.parts?.[0]?.text || "I'm sorry, I couldn't process that request.";
                renderMessage(generatedText, 'gemini');

                chatHistory.push({ role: "model", parts: [{ text: generatedText }] });

            } catch (error) {
                removeLoadingMessage();
                console.error("Gemini Chat Error:", error);
                renderMessage("Sorry, I'm having trouble connecting to the AI service right now. Please check your API key and network connection.", 'gemini');
            }
        }

        // --- THEME TOGGLE LOGIC ---
        window.toggleTheme = function () {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        }

        function setTheme(theme) {
            if (theme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('kisanTheme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('kisanTheme', 'light');
            }

            const sunIcon = document.getElementById('sunIcon');
            const moonIcon = document.getElementById('moonIcon');
            const sunIconMain = document.querySelector('#themeToggleMain .sun-icon');
            const moonIconMain = document.querySelector('#themeToggleMain .moon-icon');

            if (theme === 'dark') {
                if (sunIcon) sunIcon.style.display = 'none';
                if (moonIcon) moonIcon.style.display = 'block';
                if (sunIconMain) sunIconMain.style.display = 'none';
                if (moonIconMain) moonIconMain.style.display = 'block';
            } else {
                if (sunIcon) sunIcon.style.display = 'block';
                if (moonIcon) moonIcon.style.display = 'none';
                if (sunIconMain) sunIconMain.style.display = 'block';
                if (moonIconMain) moonIconMain.style.display = 'none';
            }
        }

        // --- LANGUAGE TOGGLE LOGIC ---
        const translations = {
            en: {
                "nav_login": "Login / Sign Up",
                "hero_title": "Connecting Farmers Directly to ",
                "hero_desc": "Connecting farmers directly with customers. Fresh produce, fair prices, and a sustainable future for local agriculture.",
                "get_started": "Get Started \u2192",
                "learn_more": "Learn More",
                "role_customer": "Customer",
                "role_farmer": "Farmer",
                "nav_profile": "My Profile",
                "nav_orders": "My Orders",
                "nav_farmer_orders": "Orders Received",
                "nav_growth": "Growth",
                "nav_signout": "Sign Out",
                "market_title": "Today's Fresh Harvest",
                "search_label": "Search Product:",
                "filter_price": "Max Price (\u20B9):",
                "filter_loc": "Location:",
                "sort_by": "Sort By:",
                "add_to_basket": "Add to Basket",
                "shop_now": "Shop Fresh Produce",
                "welcome_msg": "Welcome to KisanConnect"
            },
            te: {
                "nav_login": "\u0C32\u0C3E\u0C17\u0C3F\u0C28\u0C4D / \u0C38\u0C48\u0C28\u0C4D \u0C05\u0C2A\u0C4D",
                "hero_title": "\u0C30\u0C48\u0C24\u0C41\u0C32\u0C28\u0C41 \u0C28\u0C47\u0C30\u0C41\u0C17\u0C3E \u0C2E\u0C40\u0C24\u0C4B \u0C15\u0C32\u0C41\u0C2A\u0C41\u0C24\u0C4B\u0C02\u0C26\u0C3F",
                "hero_desc": "\u0C30\u0C48\u0C24\u0C41\u0C32\u0C28\u0C41 \u0C28\u0C47\u0C30\u0C41\u0C17\u0C3E \u0C15\u0C38\u0C4D\u0C1F\u0C2E\u0C30\u0C4D\u0C32\u0C24\u0C4B \u0C15\u0C32\u0C41\u0C2A\u0C41\u0C24\u0C4B\u0C02\u0C26\u0C3F. \u0C24\u0C3E\u0C1C\u0C3E \u0C09\u0C24\u0C4D\u0C2A\u0C24\u0C4D\u0C24\u0C41\u0C32\u0C41, \u0C28\u0C4D\u0C2F\u0C3E\u0C2F\u0C2E\u0C48\u0C28 \u0C27\u0C30\u0C32\u0C41 \u0C2E\u0C30\u0C3F\u0C2F\u0C41 \u0C38\u0C4D\u0C25\u0C3F\u0C30\u0C2E\u0C48\u0C28 \u0C2D\u0C35\u0C3F\u0C37\u0C4D\u0C2F\u0C24\u0C4D\u0C24\u0C41.",
                "get_started": "\u0C2E\u0C4A\u0C26\u0C32\u0C41\u0C2A\u0C46\u0C1F\u0C4D\u0C1F\u0C02\u0C21\u0C3F \u2192",
                "learn_more": "\u0C2E\u0C30\u0C3F\u0C02\u0C24 \u0C24\u0C46\u0C32\u0C41\u0C38\u0C41\u0C15\u0C4B\u0C02\u0C21\u0C3F",
                "role_customer": "\u0C15\u0C38\u0C4D\u0C1F\u0C2E\u0C30\u0C4D",
                "role_farmer": "\u0C30\u0C48\u0C24\u0C41",
                "nav_profile": "\u0C28\u0C3E \u0C2A\u0C4D\u0C30\u0C4A\u0C2B\u0C48\u0C32\u0C4D",
                "nav_orders": "\u0C28\u0C3E \u0C06\u0C30\u0C4D\u0C21\u0C30\u0C4D\u0C32\u0C41",
                "nav_farmer_orders": "\u0C35\u0C1A\u0C4D\u0C1A\u0C3F\u0C28 \u0C06\u0C30\u0C4D\u0C21\u0C30\u0C4D\u0C32\u0C41",
                "nav_growth": "\u0C05\u0C2D\u0C3F\u0C35\u0C43\u0C26\u0C4D\u0C27\u0C3F",
                "nav_signout": "\u0C38\u0C48\u0C28\u0C4D \u0C05\u0C35\u0C41\u0C1F\u0C4D",
                "market_title": "\u0C08 \u0C30\u0C4B\u0C1C\u0C41 \u0C24\u0C3E\u0C1C\u0C3E \u0C2A\u0C02\u0C1F",
                "search_label": "\u0C09\u0C24\u0C4D\u0C2A\u0C24\u0C4D\u0C24\u0C3F\u0C28\u0C3F \u0C36\u0C4B\u0C27\u0C3F\u0C02\u0C1A\u0C02\u0C21\u0C3F:",
                "filter_price": "\u0C17\u0C30\u0C3F\u0C37\u0C4D\u0C20 \u0C27\u0C30 (\u20B9):",
                "filter_loc": "\u0C2A\u0C4D\u0C30\u0C3E\u0C02\u0C24\u0C02:",
                "sort_by": "\u0C07\u0C32\u0C3E \u0C35\u0C30\u0C4D\u0C17\u0C40\u0C15\u0C30\u0C3F\u0C02\u0C1A\u0C41:",
                "add_to_basket": "\u0C15\u0C42\u0C21\u0C2F\u0C3F\u0C32\u0C4B \u0C1A\u0C47\u0C30\u0C4D\u0C1A\u0C02\u0C21\u0C3F",
                "shop_now": "\u0C07\u0C2A\u0C4D\u0C2A\u0C41\u0C21\u0C47 \u0C15\u0C4A\u0C28\u0C02\u0C21\u0C3F",
                "welcome_msg": "\u0C15\u0C3F\u0C38\u0C3E\u0C28\u0C4D \u0C15\u0C28\u0C46\u0C15\u0C4D\u0C1F\u0C4D\u200C\u0C15\u0C41 \u0C38\u0C4D\u0C35\u0C3E\u0C17\u0C24\u0C02"
            },
            hi: {
                "nav_login": "\u0932\u0949\u0917\u093F\u0928 / \u0938\u093E\u0907\u0928 \u0905\u092A",
                "hero_title": "\u0915\u093F\u0938\u093E\u0928\u094B\u0902 \u0915\u094B \u0938\u0940\u0927\u0947 \u0906\u092A\u0938\u0947 \u091C\u094B\u0921\u093C\u0928\u093E",
                "hero_desc": "\u0915\u093F\u0938\u093E\u0928\u094B\u0902 \u0915\u094B \u0938\u0940\u0927\u0947 \u0917\u094D\u0930\u093E\u0939\u0915\u094B\u0902 \u0938\u0947 \u091C\u094B\u0921\u093C\u0928\u093E\u0964 \u0924\u093E\u091C\u093E \u0909\u0924\u094D\u092A\u093E\u0926, \u0909\u091A\u093F\u0924 \u092E\u0942\u0932\u094D\u092F \u0914\u0930 \u0938\u094D\u0925\u093E\u0928\u0940\u092F \u0915\u0943\u0937\u093F \u0915\u0947 \u0932\u093F\u090F \u090F\u0915 \u091F\u093F\u0915\u093E\u090A \u092D\u0935\u093F\u0937\u094D\u092F\u0964",
                "get_started": "\u0936\u0941\u0930\u0941 \u0915\u0930\u0947\u0902 \u2192",
                "learn_more": "\u0914\u0930 \u091C\u093E\u0928\u0947\u0902",
                "role_customer": "\u0917\u094D\u0930\u093E\u0939\u0915",
                "role_farmer": "\u0915\u093F\u0938\u093E\u0928",
                "nav_profile": "\u092E\u0947\u0930\u093E \u092A\u094D\u0930\u094B\u092B\u093E\u0907\u0932",
                "nav_orders": "\u092E\u0947\u0930\u0947 \u0911\u0930\u094D\u0921\u0930",
                "nav_farmer_orders": "\u092A\u094D\u0930\u093E\u092A\u094D\u0924 \u0911\u0930\u094D\u0921\u0930",
                "nav_growth": "\u0935\u093F\u0915\u093E\u0938",
                "nav_signout": "\u0938\u093E\u0907\u0928 \u0906\u0909\u091F",
                "market_title": "\u0906\u091C \u0915\u0940 \u0924\u093E\u091C\u093E \u092B\u0938\u0932",
                "search_label": "\u0909\u0924\u094D\u092A\u093E\u0926 \u0916\u094B\u091C\u0947\u0902:",
                "filter_price": "\u0905\u0927\u093F\u0915\u0924\u092E \u092E\u0942\u0932\u094D\u092F (\u20B9):",
                "filter_loc": "\u0938\u094D\u0925\u093E\u0928:",
                "sort_by": "\u0915\u094D\u0930\u092E\u092C\u0926\u094D\u0927 \u0915\u0930\u0947\u0902:",
                "add_to_basket": "\u091F\u094B\u0915\u0930\u0940 \u092E\u0947\u0902 \u091C\u094B\u0921\u093C\u0947\u0902",
                "shop_now": "\u0905\u092D\u0940 \u0916\u0930\u0940\u0926\u0947\u0902",
                "welcome_msg": "\u0915\u093F\u0938\u093E\u0928 \u0915\u0928\u0947\u0915\u094D\u091F \u092E\u0947\u0902 \u0906\u092A\u0915\u093E \u0938\u094D\u0935\u093E\u0917\u0924 \u0939\u0948"
            }
        };

        window.setLanguage = function (lang) {
            localStorage.setItem('kisanLang', lang);
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang] && translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });
            document.querySelectorAll('.lang-select').forEach(sel => {
                sel.value = lang;
            });
        }

        // --- NEW: Notification Toast Function ---
        window.showNotification = function (message, type = 'default') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type === 'new-order' ? 'toast-new-order' : ''}`;

            let icon = '';
            if (type === 'new-order') icon = '';

            toast.innerHTML = `
                <div style="display:flex; align-items:center; gap:0.75rem;">
                    <span style="font-size:1.5rem;">${icon}</span>
                    <div>
                        <h4 style="font-weight:700; margin:0; font-size:0.95rem;">Notification</h4>
                        <p style="margin:0.25rem 0 0; font-size:0.85rem; color:var(--color-text-light);">${message}</p>
                    </div>
                </div>
                <button onclick="this.parentElement.remove()" style="background:none; border:none; font-size:1.2rem; cursor:pointer; color:var(--color-text-light);">&times;</button>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'fadeOut 0.5s ease-in forwards';
                toast.addEventListener('animationend', () => toast.remove());
            }, 5000);
        }

        // --- NEW: Notification Sound Function ---
        function playNotificationSound() {
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;
                const ctx = new AudioContext();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = "sine";
                osc.frequency.value = 500;
                gain.gain.setValueAtTime(0.1, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.5);
                osc.start();
                osc.stop(ctx.currentTime + 0.5);
            } catch (e) {
                console.warn("Audio context blocked or not supported");
            }
        }

        // --- NEW: Crop Doctor Logic ---
        let currentCropImageBase64 = null;

        window.handleCropImageUpload = function (input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];

                if (file.size > 5 * 1024 * 1024) {
                    showMessage("Image is too large. Please upload an image under 5MB.", 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    currentCropImageBase64 = e.target.result.split(',')[1];

                    const previewContainer = document.getElementById('cropPreviewContainer');
                    const previewImage = document.getElementById('cropPreviewImage');
                    const analyzeBtn = document.getElementById('analyzeCropBtn');

                    previewImage.src = e.target.result;
                    previewContainer.style.display = 'block';
                    analyzeBtn.style.display = 'block';

                    document.getElementById('diagnosisCard').style.display = 'none';
                }
                reader.readAsDataURL(file);
            }
        }

        window.analyzeCrop = async function () {
            if (!currentCropImageBase64) return;

            if (apiKey === "" && !isHostedEnvironment) {
                showMessage("Gemini API Key missing. Cannot analyze image.", 'error');
                return;
            }

            const btn = document.getElementById('analyzeCropBtn');
            btn.disabled = true;
            btn.textContent = 'Analyzing Crop Health...';

            const diagnosisCard = document.getElementById('diagnosisCard');
            const diagnosisContent = document.getElementById('diagnosisContent');
            diagnosisCard.style.display = 'block';
            diagnosisContent.innerHTML = `<div style="display:flex; justify-content:center; padding:2rem;"><div class="spinner" style="border-color: var(--color-secondary);"></div></div>`;

            const payload = {
                contents: [{
                    parts: [
                        { text: "Identify the disease or issue in this plant image. Provide the name of the disease, symptoms observed, and 3 specific organic/natural remedies. Format the response with bold headers for 'Disease', 'Symptoms', and 'Organic Treatments'." },
                        { inlineData: { mimeType: "image/jpeg", data: currentCropImageBase64 } }
                    ]
                }]
            };

            try {
                // Using 2.5-flash-preview as instructed
                const visionApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const response = await retryFetch(visionApiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const resultText = response.candidates?.[0]?.content?.parts?.[0]?.text;

                if (resultText) {
                    diagnosisContent.innerHTML = markdownToHtmlChat(resultText);
                    showMessage("Analysis Complete!", 'success');
                } else {
                    diagnosisContent.innerHTML = "<p>Could not identify the issue. Please try a clearer photo.</p>";
                }

            } catch (error) {
                console.error("Crop Doctor Error:", error);
                diagnosisContent.innerHTML = `<p style="color:var(--color-danger)">Analysis failed. Error: ${error.message}</p>`;
                showMessage("Failed to analyze image.", 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = ' Analyze Crop Health';
            }
        }

        // --- NEW: Government Scheme Finder Logic ---
        window.findGovernmentSchemes = async function () {
            const state = document.getElementById('schemeState').value;
            const landSize = document.getElementById('schemeLandSize').value;
            const cropType = document.getElementById('schemeCropType').value;
            const category = document.getElementById('schemeCategory').value;

            if (!state || !landSize || !cropType) {
                showMessage("Please fill in all required fields.", 'error');
                return;
            }

            if (apiKey === "" && !isHostedEnvironment) {
                showMessage("Gemini API Key missing. Cannot find schemes.", 'error');
                return;
            }

            const btn = document.getElementById('findSchemesBtn');
            btn.disabled = true;
            btn.textContent = 'Searching Schemes...';

            const resultsCard = document.getElementById('schemeResultsCard');
            const resultsContent = document.getElementById('schemeResultsContent');
            resultsCard.style.display = 'block';
            resultsContent.innerHTML = `<div style="display:flex; justify-content:center; padding:2rem;"><div class="spinner" style="border-color: #f59e0b;"></div></div>`;

            const prompt = `You are an expert on Indian agricultural government schemes and subsidies.

A farmer has the following profile:
- State: ${state}
- Land Holding: ${landSize}
- Primary Crop: ${cropType}
- Category: ${category}

List 5-7 relevant government schemes, subsidies, or benefits this farmer may be eligible for. Include:
1. Both Central Government schemes (like PM-Kisan, PMFBY, KCC) and State-specific schemes
2. For each scheme, provide:
   - **Scheme Name** (in bold)
   - Brief description (2-3 sentences)
   - Approximate benefit amount if applicable
   - How to apply (mention portal/office)
   - **Official Link:** [URL] (provide the official government website URL for the scheme, e.g., https://pmkisan.gov.in for PM-Kisan)

Format each scheme as a separate paragraph with the scheme name as a bold header. Be specific and accurate. Focus on schemes active in 2024-2025. Always include accurate official government website links.`;

            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{
                        text: "You are KisanConnect's Government Scheme Advisor AI. Your goal is to help Indian farmers discover government benefits they're entitled to. Be accurate, helpful, and provide actionable information. Always mention official sources."
                    }]
                }
            };

            try {
                const response = await retryFetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const resultText = response.candidates?.[0]?.content?.parts?.[0]?.text;

                if (resultText) {
                    // Format the response nicely
                    const formattedHtml = formatSchemeResults(resultText);
                    resultsContent.innerHTML = formattedHtml;
                    showMessage("Found relevant schemes for you!", 'success');
                } else {
                    resultsContent.innerHTML = "<p>Could not find scheme information. Please try again.</p>";
                }

            } catch (error) {
                console.error("Scheme Finder Error:", error);
                resultsContent.innerHTML = `<p style="color:var(--color-danger)">Failed to fetch schemes. Error: ${error.message}</p>`;
                showMessage("Failed to find schemes.", 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = ' Find Schemes For Me';
            }
        }

        function formatSchemeResults(text) {
            // Convert markdown-style formatting to HTML
            let html = String(text || '');

            // Convert **bold** to scheme items (headers)
            html = html.replace(/\*\*([^*]+)\*\*/g, '<h4>$1</h4>');

            // Convert URLs to clickable links with a nice button style
            html = html.replace(
                /(https?:\/\/[^\s<>"'\)]+)/g,
                '<a href="$1" target="_blank" rel="noopener noreferrer" class="scheme-link"> Visit Official Website</a>'
            );

            // Split by scheme headers and wrap in scheme-item divs
            const parts = html.split('<h4>');
            let formatted = '';

            parts.forEach((part, index) => {
                if (index === 0 && !part.trim()) return; // Skip empty first part
                if (part.trim()) {
                    // Re-add the h4 tag and wrap in scheme-item
                    const content = index === 0 ? part : '<h4>' + part;
                    formatted += `<div class="scheme-item">${content.replace(/\n/g, '<br>')}</div>`;
                }
            });

            // If no scheme-items were created, just format the text normally
            if (!formatted) {
                formatted = `<div class="scheme-item">${html.replace(/\n/g, '<br>')}</div>`;
            }

            return formatted;
        }

        // --- NEW: Weather Forecast Functions ---
        let weatherData = null;

        async function fetchWeatherData() {
            const contentEl = document.getElementById('weatherContent');
            const locationTextEl = document.getElementById('weatherLocationText');

            // Show loading
            contentEl.innerHTML = `
                <div class="weather-loading">
                    <div class="spinner" style="border-color: #0ea5e9;"></div>
                    <p style="margin-top: 1rem; color: var(--color-text-light);">Fetching weather data...</p>
                </div>
            `;

            try {
                // Get user's location (use existing location or geolocation)
                let lat = 17.385; // Default: Hyderabad
                let lon = 78.4867;
                let locationName = "Hyderabad, India";

                // Try to get current position
                if (navigator.geolocation) {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 });
                        });
                        lat = position.coords.latitude;
                        lon = position.coords.longitude;
                        locationName = `${lat.toFixed(2)}N, ${lon.toFixed(2)}E`;
                    } catch (geoError) {
                        console.log("Using default location - geolocation failed:", geoError.message);
                    }
                }

                locationTextEl.textContent = locationName;

                // Fetch weather from Open-Meteo (free API, no key required)
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code,wind_speed_10m&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,wind_speed_10m_max&timezone=auto`;

                const response = await fetch(weatherUrl);
                if (!response.ok) throw new Error('Weather API request failed');

                weatherData = await response.json();
                renderWeatherPage(weatherData);

            } catch (error) {
                console.error("Weather fetch error:", error);
                contentEl.innerHTML = `
                    <div class="weather-error">
                        <p> Failed to load weather data.</p>
                        <p style="font-size: 0.9rem; margin-top: 0.5rem;">Please check your internet connection and try again.</p>
                    </div>
                `;
            }
        }

        function renderWeatherPage(data) {
            const contentEl = document.getElementById('weatherContent');
            const current = data.current;
            const daily = data.daily;

            const currentIcon = getWeatherIcon(current.weather_code);
            const currentCondition = getWeatherCondition(current.weather_code);

            // Build 7-day forecast cards
            const forecastCards = daily.time.map((date, index) => {
                const dayDate = new Date(date);
                const dayName = index === 0 ? 'Today' : dayDate.toLocaleDateString('en-US', { weekday: 'short' });
                const dateStr = dayDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                const icon = getWeatherIcon(daily.weather_code[index]);
                const high = Math.round(daily.temperature_2m_max[index]);
                const low = Math.round(daily.temperature_2m_min[index]);
                const rainProb = daily.precipitation_probability_max[index];

                return `
                    <div class="forecast-card">
                        <div class="forecast-day">${dayName}</div>
                        <div class="forecast-date">${dateStr}</div>
                        <div class="forecast-icon">${icon}</div>
                        <div class="forecast-temps">
                            <span class="forecast-high">${high}</span>
                            <span class="forecast-low">${low}</span>
                        </div>
                        <div class="forecast-rain"> <span>${rainProb}%</span></div>
                    </div>
                `;
            }).join('');

            // Generate farming insights
            const insights = getFarmingInsights(data);

            contentEl.innerHTML = `
                <!-- Current Weather Card -->
                <div class="current-weather-card">
                    <div class="current-weather-main">
                        <div class="current-temp">${Math.round(current.temperature_2m)}<span>C</span></div>
                        <div class="current-weather-icon">${currentIcon}</div>
                        <div class="current-weather-details">
                            <div class="current-condition">${currentCondition}</div>
                        </div>
                    </div>
                    <div class="current-meta">
                        <div class="current-meta-item">
                            <div class="label">Humidity</div>
                            <div class="value">${current.relative_humidity_2m}%</div>
                        </div>
                        <div class="current-meta-item">
                            <div class="label">Wind</div>
                            <div class="value">${Math.round(current.wind_speed_10m)} km/h</div>
                        </div>
                        <div class="current-meta-item">
                            <div class="label">Rain Today</div>
                            <div class="value">${daily.precipitation_probability_max[0]}%</div>
                        </div>
                    </div>
                </div>

                <!-- 7-Day Forecast -->
                <h3 class="forecast-title"> 7-Day Forecast</h3>
                <div class="forecast-grid">
                    ${forecastCards}
                </div>

                <!-- Farming Insights -->
                <div class="farming-insights">
                    <h3> Farming Insights</h3>
                    ${insights}
                </div>
            `;
        }

        function getWeatherIcon(code) {
            // WMO Weather interpretation codes
            const icons = {
                0: '', 1: '', 2: '', 3: '',
                45: '', 48: '',
                51: '', 53: '', 55: '',
                56: '', 57: '',
                61: '', 63: '', 65: '',
                66: '', 67: '',
                71: '', 73: '', 75: '', 77: '',
                80: '', 81: '', 82: '',
                85: '', 86: '',
                95: '', 96: '', 99: ''
            };
            return icons[code] || '';
        }

        function getWeatherCondition(code) {
            const conditions = {
                0: 'Clear Sky', 1: 'Mostly Clear', 2: 'Partly Cloudy', 3: 'Overcast',
                45: 'Foggy', 48: 'Depositing Fog',
                51: 'Light Drizzle', 53: 'Drizzle', 55: 'Heavy Drizzle',
                56: 'Freezing Drizzle', 57: 'Heavy Freezing Drizzle',
                61: 'Light Rain', 63: 'Moderate Rain', 65: 'Heavy Rain',
                66: 'Light Freezing Rain', 67: 'Heavy Freezing Rain',
                71: 'Light Snow', 73: 'Moderate Snow', 75: 'Heavy Snow', 77: 'Snow Grains',
                80: 'Light Showers', 81: 'Moderate Showers', 82: 'Heavy Showers',
                85: 'Light Snow Showers', 86: 'Heavy Snow Showers',
                95: 'Thunderstorm', 96: 'Thunderstorm with Hail', 99: 'Severe Thunderstorm'
            };
            return conditions[code] || 'Unknown';
        }

        function getFarmingInsights(data) {
            const insights = [];
            const rainProb = data.daily.precipitation_probability_max[0];
            const maxTemp = data.daily.temperature_2m_max[0];
            const minTemp = data.daily.temperature_2m_min[0];
            const humidity = data.current.relative_humidity_2m;
            const wind = data.current.wind_speed_10m;

            // Rain-based insights
            if (rainProb > 70) {
                insights.push({
                    icon: '',
                    text: `<strong>High rain probability (${rainProb}%)</strong>: Avoid irrigation today. Ensure proper drainage in fields.`
                });
            } else if (rainProb < 20) {
                insights.push({
                    icon: '',
                    text: `<strong>Low rain expected</strong>: Consider irrigating crops, especially during early morning or evening.`
                });
            }

            // Temperature insights
            if (maxTemp > 38) {
                insights.push({
                    icon: '',
                    text: `<strong>High temperature alert (${maxTemp}C)</strong>: Provide shade for sensitive crops. Increase watering frequency.`
                });
            } else if (minTemp < 10) {
                insights.push({
                    icon: '',
                    text: `<strong>Cold night expected (${minTemp}C)</strong>: Protect frost-sensitive crops with covers.`
                });
            }

            // Humidity insights
            if (humidity > 85) {
                insights.push({
                    icon: '',
                    text: `<strong>High humidity (${humidity}%)</strong>: Watch for fungal diseases. Avoid overhead irrigation.`
                });
            }

            // Wind insights
            if (wind > 30) {
                insights.push({
                    icon: '',
                    text: `<strong>Strong winds expected</strong>: Secure greenhouse covers and postpone spraying operations.`
                });
            }

            // Best practice
            insights.push({
                icon: '',
                text: `<strong>Best practice</strong>: Check weather before applying pesticides. Avoid spraying if rain is expected within 4-6 hours.`
            });

            return insights.map(i => `
                <div class="insight-item">
                    <span class="insight-icon">${i.icon}</span>
                    <span class="insight-text">${i.text}</span>
                </div>
            `).join('');
        }

        // --- Initialization on Load ---
        window.onload = initApp;
    </script>

</body>

</html>
